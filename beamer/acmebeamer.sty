% Time-stamp: <2011-02-11 13:44:55 cmauclai>
%
% Copyright 2010 by Cedric Mauclair
%
% This file may be distributed and/or modified
%
% 1. under the CCPL Attribution-ShareAlike License
% (http://creativecommons.org/licenses/by-sa/3.0/legalcode) and/or
% 2. under the GNU Public License 3 (http://www.gnu.org/licenses/gpl.html).
%
% Created by Cedric Mauclair for the 'acme' themes.
%
% Latest major version: 3.0
% Date: 2010-12-20
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Beamer theme ''acme-beamer'' (c) Cedric Mauclair, 2010.
%   * snippets from ''progressbar'' beamer theme (c) Sylvain Bouveret, 2009.
%   * snippets from ''leman'' beamer theme (c) David Chemouil, 2009.
%
% Version: 1.0   [2009-12-15]
%     First release.
% Version: 1.0.1 [2010-01-04]
%     Minor revision.
% Version: 1.1   [2010-01-05]
%     * Added an optional argument to maketitle command.
%     * Modified enumerate environment to pifont dings.
% Version: 1.2   [2010-02-23]
%     * Added a custom to bigbox to do whatever you want.
%     * Added the support for frame subtitles.
% Version: 2.0   [2010-11-22]
%     * Huge rewrite.
%     * Using 'pgfkeys' instead of 'xkeyval'.
% Version: 2.1   [2010-11-26]
%     Rewrote framedtext environment.
% Version: 3.0   [2010-12-20]
%     Huge rewrite of framed, framedtext and blocks.
% Version: 3.01  [2011-01-07]
%     Removed the iwona package requirement.
% Version: 3.02  [2011-01-13]
%     Reworked the frametitle: empty frametitles into (sub)sectioned
%     frametitles.
% Version: 4.0alpha [2011-02-04]
%     Reworked to work with the new toolbox.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\ProvidesPackage{acmebeamer}[2011/02/04 Beamer theme.]
% \ProvidesPackageRCS $Header: acmebeamer.sty,v 3.0 2010/12/20 18:00:00 acme Exp$


%<< [· Required packages ·····················] >>

\RequirePackage{acmetoolbox}
\RequirePackage{tikz}

\DeclareOption{portrait}{%
  \@tempdima=\beamer@paperwidth
  \beamer@paperwidth=\beamer@paperheight
  \beamer@paperheight=\@tempdima}

\ProcessOptions

%>>
%<< [· Usefull definitions ···················] >>

\newcommand\usebeamer[2][fg]
  {\usebeamerfont{#2}\usebeamercolor[#1]{#2}}

\renewenvironment{center}
  {\endgraf\centering}
  {\endgraf}

\def\slide#1 of #2{{\small(#1/#2)}}

\let\oldsetbeamersize\setbeamersize
\newdimen\leftmargin
\newdimen\rightmargin
\def\setbeamersize#1{
  \oldsetbeamersize{#1}
  \leftmargin=\beamer@leftmargin
  \rightmargin=\beamer@rightmargin
  \setlength\leftmargini{\leftmargin}
  \setlength\leftmarginii{\labelsep}
  \setlength\leftmarginiii{\labelsep}
  \setlength  \labelwidth{\leftmargini}
  \addtolength\labelwidth{-\labelsep}}

%>>
%<< [· Graphics utilities ····················] >>

\tikzset{bb/.style={use as bounding box}}

\def\unitsquare{\dosingleempty\dounitsquare}
\def\dounitsquare[#1]{%
  \begin{tikzpicture}
    [baseline, x=1pt, y=1pt]
    \path [#1] (0,0) -- ++(1,0) -- ++(0,1) -- ++(-1,0) -- cycle;
  \end{tikzpicture}\ignorespaces}

\def\fullsquare{\dosingleempty\dofullsquare}
\def\dofullsquare[#1]{%
  \begin{tikzpicture}
    [baseline, x=1pt, y=1pt]
    \path [#1] (-0.5,-0.5) -- ++(1,0) -- ++(0,1) -- ++(-1,0) -- cycle;
  \end{tikzpicture}\ignorespaces}

\def\unitcircle{\dosingleempty\dounitcircle}
\def\dounitcircle[#1]{%
  \begin{tikzpicture}
    [baseline, x=1pt, y=1pt]
    \path [#1] (0.5,0.5) circle (0.5);
  \end{tikzpicture}\ignorespaces}

\def\fullcircle{\dosingleempty\dofullcircle}
\def\dofullcircle[#1]{%
  \begin{tikzpicture}
    [baseline, x=1pt, y=1pt]
    \path [#1] (0,0) circle (0.5);
  \end{tikzpicture}\ignorespaces}

\def\unittriangle{\dosingleempty\dounittriangle}
\def\dounittriangle[#1]{%
  \begin{tikzpicture}
    [baseline, x=1pt, y=1pt]
    \path [#1] (0,0) -- ++(1,0.5) -- ++(-1,0.5) -- cycle;
  \end{tikzpicture}\ignorespaces}

\def\fulltriangle{\dosingleempty\dofulltriangle}
\def\dofulltriangle[#1]{%
  \begin{tikzpicture}
    [baseline, x=1pt, y=1pt]
    \path [#1] (0,-0.5) -- ++(1,0.5) -- ++(-1,0.5) -- cycle;
  \end{tikzpicture}\ignorespaces}

%<< * smileys factory                    >>

\tikzset{
  smileyenv/.style n args={3}{
    x=#1, y=#1, color=#2, very thick, rounded corners=1pt,
    line cap=round, parabola height=-1.6, #3}}

\newcommand\gsmiley[3][1mm]{%
  \begin{tikzpicture} [smileyenv={#1}{#2}{#3}]
    \path [draw, bb] (0, 0) circle (2.2);          % head
    \path [draw] (-1.2, -0.7) parabola ++(2.4, 0); % smile
    \path [fill] (-0.7,  0.6) circle (0.3);        % eye 1
    \path [fill] ( 0.7,  0.6) circle (0.3);        % eye 2
  \end{tikzpicture}}
\newcommand\wgsmiley[3][1mm]{%
  \begin{tikzpicture}
    [smileyenv={#1}{#2}{#3}]
    \path [draw, bb] (0, 0) circle (2.2);                % head
    \path [fill] (-1.5, -0.6) arc(200:340:1.6) -- cycle; % smile
    \path [draw] (-1.1,  0.5) -- ++( 0.7, 0.5);          % eye 1
    \path [draw] ( 1.1,  0.5) -- ++(-0.7, 0.5);          % eye 2
  \end{tikzpicture}}
\newcommand\wsmiley[3][1mm]{%
  \begin{tikzpicture} [smileyenv={#1}{#2}{#3}]
    \path [draw, bb] ( 0,    0)   circle (2.2);   % head
    \path [fill=darkred] (-0.7, -0.5) -- ++(0, -0.3)
             arc (180:360:0.7) -- ++(0, 0.3) -- cycle; % tongue
    \path [fill] ( 0.7,  0.6) circle (0.3);            % eye 1
    \path [draw] (-1.1,  0.6) arc (200:340:0.4);       % eye 2
  \end{tikzpicture}}
% \newcommand\wmiley[3][1mm]{%
%   \begin{tikzpicture} [smileyenv={#1}{#2}{#3}]
%     \path [draw] ( 0,    0)   circle (2.2);        % head
%     \path [draw] (-1.2, -0.5) -- ++(2.4, 0);       % mouth
%     \path [fill] (-0.2, -0.5) -- ++(0, -0.3)
%              arc (180:360:0.6) -- ++(0, 0.3);      % tongue
%     \path [fill] ( 0.7,  0.6) circle (0.3);        % eye 1
%     \path [draw] (-1.1,  0.6) arc (200:340:0.4);   % eye 2
%   \end{tikzpicture}}
% \newcommand\wsmiley[3][1mm]{%
%   \begin{tikzpicture} [smileyenv={#1}{#2}{#3}]
%     \path [draw] ( 0,    0)   circle (2.2);        % head
%     \path [draw] (-1.2, -0.7) parabola ++(2.4, 0); % smile
%     \path [fill] ( 0.7,  0.6) circle (0.3);        % eye 1
%     \path [draw] (-1.1,  0.6) arc (200:340:0.4);   % eye 2
%   \end{tikzpicture}}
\newcommand\msmiley[3][1mm]{%
  \begin{tikzpicture} [smileyenv={#1}{#2}{#3}]
    \path [draw, bb] (0, 0) circle (2.2);   % head
    \path [draw] (-1  , -1) -- ++(2, 0.5);  % mouth
    \path [fill] (-0.7,  0.6) circle (0.3); % eye 1
    \path [fill] ( 0.7,  0.6) circle (0.3); % eye 2
  \end{tikzpicture}}
\newcommand\fsmiley[3][1mm]{%
  \begin{tikzpicture} [smileyenv={#1}{#2}{#3}]
    \path [draw, bb] (0, 0) circle (2.2);        % head
    \path [fill] (-0.7,  0.6) circle (0.3);      % eye 1
    \path [fill] ( 0.7,  0.6) circle (0.3);      % eye 2
    \path [draw] (-1.2, -1)   parabola +(2.4,0); % mouth
  \end{tikzpicture}}
\newcommand\csmiley[3][1mm]{%
  \begin{tikzpicture} [smileyenv={#1}{#2}{#3}]
    \path [draw, bb] (0, 0) circle (2.2);        % head
    \path [draw, fill, very thin, sharp corners, shift={(1.4, .8)}, scale=.2]
      (0, 0) to[controls=+(270:2)  and +(90:1)]  ++(-1, -4)
             to[controls=+(270:.1) and +(180:1)] ++(1, -1)
             to[controls=+(0:1)    and +(90:.1)] ++(1, 1)
             to[controls=+(90:1)   and +(270:2)] ++(-1, 4) ;
    \path [fill] (-0.7,  0.6) circle (0.3);      % eye 1
    \path [fill] ( 0.7,  0.6) circle (0.3);      % eye 2
    \path [draw] (-1.2, -1)   parabola +(2.4,0); % mouth
  \end{tikzpicture}}

\newcommand\grin[1][]{\gsmiley[3pt]{darkgreen}{#1}}
\newcommand\wide[1][]{\wgsmiley[3pt]{darkgreen}{#1}}
\newcommand\wink[1][]{\wsmiley[3pt]{darkgreen}{#1}}
\newcommand\mood[1][]{\msmiley[3pt]{darkorange}{#1}}
\newcommand\frwn[1][]{\fsmiley[3pt]{darkred}{parabola height=1.6, #1}}
\newcommand\whng[1][]{\csmiley[3pt]{darkred}{parabola height=1.6, #1}}

%>>
%<< * warn sign                          >>

\newcommand\warn[1][scale=1.5]{%
  \begin{tikzpicture}[%
    warning/.style={
      line width=2pt,
      draw=darkred, rounded corners,
      shape=isosceles triangle,
      shape border rotate=90,
      isosceles triangle apex angle=60,
      inner xsep=0pt,
      inner ysep=1.4pt,
      font=\fontfamily{qbk}\selectfont\bfseries,
      text=black, #1}]
    \node [warning] {!};
  \end{tikzpicture}}

%>>
%<< * \ok, \ko                           >>

\def\ok{{\color{darkgreen}\hbox to .9em{\ding{51}}}}
\def\ko{{\color{darkred}\hbox to .9em{\ding{55}}}}

%>>

%>>

%<< [· Title page ····························] >>

\pgfkeys{/acme/titlepage/.cd,
  .dimensions={lineoffset}, lineoffset=.15\paperheight,
  logo/.is choice,
  logo/none/.code=\def\inserttitlegraphic{},
  logo/institute/.code=\def\inserttitlegraphic{\insertinstitute},
  customlogo/.code=\def\inserttitlegraphic{#1}}

\def\acmeframetitlehack{%
  \def\beamer@checkframetitle{%
    \doifnextbgroupelse
    \beamer@inlineframetitle
    {\gdef\beamer@frametitle{none}}}}

\def\maketitle{\dodoubleempty\domaketitle}
\def\domaketitle[#1][#2]{%
  \setuptitlepage[#1]%
  \begin{frame}[c,plain,#2]\titlepage\end{frame}%
  \acmeframetitlehack
  \usebeamer{normal text}}


\def\setuptitlepage{\getparameters[/acme/titlepage]}

\defbeamertemplate{title page}{acme}[2][]{\setuptitlepage[#1]#2}


%>>
%<< [· Table of contents ·····················] >>

\newlength\frametocheight
\newlength\frametochmargin
\newlength\frametocvmargin

\def\frametoc{%
  \doifnextbgroupelse
    \doframetoc
    {\doframetoc{}}}

\def\doframetoc#1{%
  \doifnextoptionalelse
    {\dodoframetoc{#1}}
    {\dodoframetoc{#1}[]}}

\def\dodoframetoc#1[#2]{%
  \begin{frame}{#1}
    \parskip=0pt\vfill
    \usebeamer{frametoc}%
    \begin{framedtext}
      [frame=on, background=on,
       width=\hsize, minheight=50pt, offset=10pt,
       tikzoptions={draw=fg, fill=bg, thick, rounded corners=2pt}]
         \vskip\partopsep\vskip-\topsep\vskip-2pt% WTF value
         \tableofcontents[#2]%
    \end{framedtext}\vfill%
  \end{frame}}

%>>
%<< [· Page number ···························] >>

%D Different options for the page numbers on the slides:
%D    - 'none': no page number
%D    - 'boxed': put the page number into a small box
%D    - 'plain': put the page number 'as is'
%D    - 'custom': use the supplied argument.

\pgfkeys{/acme/page numbers/.cd,
  style/.is choice, style/.default=plain,
  style/none/.code=\let\acme@pagenumbers\@empty,
  style/boxed/.code=\let\acme@pagenumbers\acme@pagenumbers@boxed,
  style/plain/.code=\let\acme@pagenumbers\acme@pagenumbers@plain,
  custom/.code=\def\acme@pagenumbers{#1}}

\let\acme@pagenumbers\@empty

\def\setuppagenumbers{\getparameters[/acme/page numbers]}

%D Boxed numbers

\def\acme@pagenumbers@boxed{\bgroup%
  \usebeamerfont{page number in head/foot}%
  \setbox0=\hbox{\strut00/00}\@tempdima=\wd0\@tempdimb=\ht0
  \multiply\@tempdima by 15\divide\@tempdima by 10%
  \multiply\@tempdimb by 2%
  \usebeamercolor{page number in head/foot}%
  \hbox\bgroup\begin{tikzpicture}%
    \node [rectangle, draw=fg, fill=bg, rounded corners=1pt, minimum width=\@tempdima,
           inner sep=0pt, outer sep=0pt, minimum height=\@tempdimb,
           text=fg, text depth=1pt]%
    {\setbox0=\hbox{\strut00}\@tempdima=\wd0%
      \usebeamerfont{page number in head/foot}\usebeamercolor[fg]{page number in head/foot}%
      \strut\hyperlinkpresentationstart{\hbox to\@tempdima{\hfill\insertframenumber}}/%
      \hyperlinkpresentationend{\hbox to\@tempdima{\inserttotalframenumber\hfill}}};
  \end{tikzpicture}\egroup\egroup}

%D Plain numbers

\def\acme@pagenumbers@plain{\bgroup%
  \usebeamerfont{page number in head/foot}\usebeamercolor[fg]{page number in head/foot}%
  \strut\hyperlinkpresentationstart{\insertframenumber}/%
  \hyperlinkpresentationend{\inserttotalframenumber}\egroup}

%>>

%<< [· Headline ······························] >>

%<< — setups ············· — >>

\pgfkeys{/acme/headline/.cd,
  .parameters=frame, frame=,
  %% —————————————————————————————————————————————————— %%
  left/.is choice,
  left/empty/.code=\let\acme@headline@left\@empty,
  left/page numbers/.code=\let\acme@headline@left\acme@pagenumbers,
  left/custom/.code=\let\acme@headline@left\acme@headline@left@custom,
  left/predefined/.code=\acme@headline@predefined{left}{#1},
  left/.unknown/.code={%
    \let\acme@headline@left@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@headline@left@predefined@key}},
  %%
  left/section/.is choice, left/section/.default=text,
  left/section/text/.style={/acme/headline/left/predefined=section},
  left/subsection/.is choice, left/subsection/.default=text,
  left/subsection/text/.style={/acme/headline/left/predefined=subsection},
  left/subsection/bullets/.code=\let\acme@headline@left\acme@headline@subsection@bullets,
  left/subsection/squares/.code=\let\acme@headline@left\acme@headline@subsection@squares,
  %% —————————————————————————————————————————————————— %%
  center/.is choice,
  center/empty/.code=\let\acme@headline@center\@empty,
  center/page numbers/.code=\let\acme@headline@center\acme@pagenumbers,
  center/custom/.code=\let\acme@headline@center\acme@headline@center@custom,
  center/predefined/.code=\acme@headline@predefined{center}{#1},
  center/.unknown/.code={%
    \let\acme@headline@center@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@headline@center@predefined@key}},
  %%
  center/section/.is choice, center/section/.default=text,
  center/section/text/.style={/acme/headline/center/predefined=section},
  center/subsection/.is choice, center/subsection/.default=text,
  center/subsection/text/.style={/acme/headline/center/predefined=subsection},
  center/subsection/bullets/.code=\let\acme@headline@center\acme@headline@subsection@bullets,
  center/subsection/squares/.code=\let\acme@headline@center\acme@headline@subsection@squares,
  %% —————————————————————————————————————————————————— %%
  right/.is choice,
  right/empty/.code=\let\acme@headline@right\@empty,
  right/page numbers/.code=\let\acme@headline@right\acme@pagenumbers,
  right/custom/.code=\let\acme@headline@right\acme@headline@right@custom,
  right/predefined/.code=\acme@headline@predefined{right}{#1},
  right/.unknown/.code={%
    \let\acme@headline@right@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@headline@right@predefined@key}},
  %%
  right/section/.is choice, right/section/.default=text,
  right/section/text/.style={/acme/headline/right/predefined=section},
  right/subsection/.is choice, right/subsection/.default=text,
  right/subsection/text/.style={/acme/headline/right/predefined=subsection},
  right/subsection/bullets/.code=\let\acme@headline@right\acme@headline@subsection@bullets,
  right/subsection/squares/.code=\let\acme@headline@right\acme@headline@subsection@squares}

\let\acme@headline@left\@empty
\let\acme@headline@center\@empty
\let\acme@headline@right\@empty

\def\headlineleft{\def\acme@headline@left@custom}     \headlineleft{}
\def\headlinecenter{\def\acme@headline@center@custom} \headlinecenter{}
\def\headlineright{\def\acme@headline@right@custom}   \headlineright{}

%>>
%<< — sections ··········· — >>
\let\acme@headline@section\@empty
%>>
%<< — subsections ········ — >>

\def\acme@headline@subsection@bullets{%
  \@acme@headline@navigation}

\def\acme@headline@subsection@squares{%
  \setbeamertemplate{mini frame}{%
    \begin{pgfpicture}{0pt}{0pt}{0.1cm}{0.1cm}
      \pgfpathrectangle{\pgfpoint{0.0cm}{0.0cm}}{\pgfpoint{0.1cm}{0.1cm}}
      \pgfusepath{fill,stroke}
    \end{pgfpicture}}%
  \setbeamertemplate{mini frame in current subsection}{%
    \begin{pgfpicture}{0pt}{0pt}{0.1cm}{0.1cm}
      \pgfpathrectangle{\pgfpoint{0.0cm}{0.0cm}}{\pgfpoint{0.1cm}{0.1cm}}
      \pgfusepath{stroke}
    \end{pgfpicture}}\@acme@headline@navigation}

\let\acme@headline@subsection\@empty

%>>
%<< — predefined ········· — >>
\def\acme@headline@predefined#1#2{%
  \@EA\def\csname acme@headline@#1\endcsname
    {\usebeamertemplate{#2 in head/foot}}}
%>>
%<< -- UGLY HACK, BEWARE! IT DOESN'T WORK QUITE RIGHT FOR NOW >>

\def\@acme@headline@navigation{%
  \def\sectionentry##1##2##3##4##5{}% section number, section title, page
  \def\slideentry##1##2##3##4##5##6{%
    % section number, subsection number, slide number, first/last frame, page number, part number
    \ifnum##6=\c@part\ifnum##2>0\ifnum##3>0%
    \ifnum\c@section=##1\beamer@xpos=##2\relax%
    \else\beamer@xpos=0\relax\fi%
    \beamer@ypos=0\relax%
    \hbox to 0pt{%
      \beamer@tempdim=-\beamer@vboxoffset%
      \advance\beamer@tempdim by-\beamer@boxsize%
      \multiply\beamer@tempdim by\beamer@ypos%
      % \advance\beamer@tempdim by -.05cm%ACME FIX
      \raise\beamer@tempdim\hbox{%
        \beamer@tempdim=\beamer@boxsize%
        \multiply\beamer@tempdim by\beamer@xpos%
        \advance\beamer@tempdim by -\beamer@boxsize%
        \advance\beamer@tempdim by 1pt%
        \kern\beamer@tempdim\hbox{\beamer@link(##4){%
            \usebeamerfont{mini frame}%
            \ifnum\c@section=##1%
              \ifnum\c@subsection=##2%
                \usebeamercolor[fg]{mini frame}%
                \usebeamertemplate{mini frame}%
              \else%
                \usebeamercolor{mini frame}%
                \usebeamertemplate{mini frame in other subsection}%
              \fi%
            \fi%
          }}}%\hskip-10cm plus 1fil%
    }\fi\fi%
    \else%
    \fakeslideentry{##1}{##2}{##3}{##4}{##5}{##6}%
    \fi\ignorespaces}
  \def\fakeslideentry##1##2##3##4##5##6{%
    \ifnum##2>0\ifnum##3>0%
    \ifbeamer@compress%
    \advance\beamer@xpos by1\relax%
    \else%
    \beamer@xpos=##3\relax%
    \beamer@ypos=##2\relax%
    \fi%
    \hbox to 0pt{\beamer@tempdim=-\beamer@vboxoffset%
      \advance\beamer@tempdim by -\beamer@boxsize%
      \multiply\beamer@tempdim by\beamer@ypos%
      \advance\beamer@tempdim by -.05cm%
      \raise\beamer@tempdim\hbox{}}\fi\fi\ignorespaces}
  \hbox{%
    \setbox\beamer@sectionbox=\hbox{}%
    \hskip-1.875ex plus-1fill\dohead%
    \box\beamer@sectionbox\hfil\hskip.3cm}%
}

%>>

\def\setupheadline{\getparameters[/acme/headline]}

\defbeamertemplate{headline}{acme}{
  \setupframed[margin=0pt]
  \expandonearg\setupframed[\acmeheadlineframe]
  \let\next\@empty
  \ifnum\insertframenumber=1 \else
    \@tempdima=\acmeframedwidth
    \advance\@tempdima by -\acmeframedleftmargin%
    \advance\@tempdima by -\acmeframedrightmargin%
    \def\next{%
      \vskip\acmeframedtopmargin
      \vbox\bgroup\strut
      \hskip\acmeframedleftmargin
      \hbox to \@tempdima\bgroup%
        \usebeamer{headline}%
        \hbox to \@tempdima{\acme@headline@left\hss}\hskip-\@tempdima
        \hbox to \@tempdima{\hss\acme@headline@center\hss}\hskip-\@tempdima
        \hbox to \@tempdima{\hss\acme@headline@right}
      \egroup\egroup
      \vskip\acmeframedbottommargin}
    \ifx\acme@headline@left\@empty
    \ifx\acme@headline@center\@empty
    \ifx\acme@headline@right\@empty
      \let\next\@empty\fi\fi\fi% nothing to show, then reclaim space
  \fi\next}

%>>
%<< [· Footline ······························] >>

%<< — setups ············· — >>

\pgfkeys{/acme/footline/.cd,
  .parameters=frame, frame=,
  %% —————————————————————————————————————————————————— %%
  left/.is choice,
  left/empty/.code=\let\acme@footline@left\@empty,
  left/page numbers/.code=\let\acme@footline@left\acme@pagenumbers,
  left/custom/.code=\let\acme@footline@left\acme@footline@left@custom,
  left/predefined/.code=\acme@footline@predefined{left}{#1},
  left/.unknown/.code={%
    \let\acme@footline@left@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@footline@left@predefined@key}},
  %%
  left/section/.is choice, left/section/.default=text,
  left/section/text/.style={/acme/footline/left/predefined=section},
  left/subsection/.is choice, left/subsection/.default=text,
  left/subsection/text/.style={/acme/footline/left/predefined=subsection},
  left/subsection/bullets/.code=\let\acme@footline@left\acme@footline@subsection@bullets,
  left/subsection/squares/.code=\let\acme@footline@left\acme@footline@subsection@squares,
  %% —————————————————————————————————————————————————— %%
  center/.is choice,
  center/empty/.code=\let\acme@footline@center\@empty,
  center/page numbers/.code=\let\acme@footline@center\acme@pagenumbers,
  center/custom/.code=\let\acme@footline@center\acme@footline@center@custom,
  center/predefined/.code=\acme@footline@predefined{center}{#1},
  center/.unknown/.code={%
    \let\acme@footline@center@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@footline@center@predefined@key}},
  %%
  center/section/.is choice, center/section/.default=text,
  center/section/text/.style={/acme/footline/center/predefined=section},
  center/subsection/.is choice, center/subsection/.default=text,
  center/subsection/text/.style={/acme/footline/center/predefined=subsection},
  center/subsection/bullets/.code=\let\acme@footline@center\acme@footline@subsection@bullets,
  center/subsection/squares/.code=\let\acme@footline@center\acme@footline@subsection@squares,
  %% —————————————————————————————————————————————————— %%
  right/.is choice,
  right/empty/.code=\let\acme@footline@right\@empty,
  right/page numbers/.code=\let\acme@footline@right\acme@pagenumbers,
  right/custom/.code=\let\acme@footline@right\acme@footline@right@custom,
  right/predefined/.code=\acme@footline@predefined{right}{#1},
  right/.unknown/.code={%
    \let\acme@footline@right@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@footline@right@predefined@key}},
  %%
  right/section/.is choice, right/section/.default=text,
  right/section/text/.style={/acme/footline/right/predefined=section},
  right/subsection/.is choice, right/subsection/.default=text,
  right/subsection/text/.style={/acme/footline/right/predefined=subsection},
  right/subsection/bullets/.code=\let\acme@footline@right\acme@footline@subsection@bullets,
  right/subsection/squares/.code=\let\acme@footline@right\acme@footline@subsection@squares}

% \definesetup{footline}

\let\acme@footline@left\@empty
\let\acme@footline@center\@empty
\let\acme@footline@right\@empty

\def\footlineleft{\def\acme@footline@left@custom}     \footlineleft{}
\def\footlinecenter{\def\acme@footline@center@custom} \footlinecenter{}
\def\footlineright{\def\acme@footline@right@custom}   \footlineright{}

%>>
%<< — predefined ········· — >>

\def\acme@footline@predefined#1#2{%
  \@EA\def\csname acme@footline@#1\endcsname
    {\usebeamertemplate{#2 in head/foot}}}

%>>

\def\setupfootline{\getparameters[/acme/footline]}

\defbeamertemplate{footline}{acme}{
  \setupframed[margin=0pt]
  \expandonearg\setupframed[\acmefootlineframe]
  \let\next\@empty
  \ifnum\insertframenumber=1 \else
    \@tempdima=\acmeframedwidth
    \advance\@tempdima by -\acmeframedleftmargin%
    \advance\@tempdima by -\acmeframedrightmargin%
    \def\next{%
      \vskip-\acmeframedbottommargin
      \vskip\acmeframedtopmargin
      \vbox\bgroup\vss\strut
      \hskip\acmeframedleftmargin
      \hbox to \@tempdima\bgroup
        \usebeamer{footline}%
        \hbox to \@tempdima{\acme@footline@left\hss}\hskip-\@tempdima
        \hbox to \@tempdima{\hss\acme@footline@center\hss}\hskip-\@tempdima
        \hbox to \@tempdima{\hss\acme@footline@right}
      \egroup\egroup
      \vskip\acmeframedbottommargin}
    \ifx\acme@footline@left\@empty
    \ifx\acme@footline@center\@empty
    \ifx\acme@footline@right\@empty
      \let\next\@empty\fi\fi\fi% nothing to show, then reclaim space
  \fi\next}

%>>
%<< [· Frametitle ····························] >>

\defbeamertemplate{frametitle}{acme}[1]{#1}

%>>

%<< [· Emphasis ······························] >>

% BEWARE: VERY UGLY HACK BELOW
\def\emstyle{\def\@emstyle}
\emstyle{\usebeamerfont{emphasis}\usebeamercolor[fg]{emphasis}}
% \emstyle{\usebeamerfont{emphasis}\color{fg}}
\DeclareRobustCommand\em
{\@nomath\em \ifdim \fontdimen\@ne\font >\z@
  \color{normal text.fg}\mdseries \else\@emstyle \fi}
\let\beamer@orignewcomnoopt=\beamer@newcomnoopt
\let\beamer@orignewcomopt=\beamer@newcomopt
\long\def\beamer@newcomnoopt#1#2#3{%
  \ifnum#2=0\relax%
  \expandafter\def\expandafter#1\expandafter{\expandafter\beamer@sortzero\expandafter{\csname beamerx@\string#1\endcsname}}%
  \else
  \expandafter\def\expandafter#1\expandafter{\expandafter\beamer@sort\expandafter{\csname beamerx@\string#1\endcsname}{#2}}%
  \fi%
  \beamer@argscount=#2\relax%
  \advance\beamer@argscount by 1\relax%
  \expandafter\renewcommand\csname beamerx@\string#1\endcsname[\beamer@argscount]{#3}%
}
\long\def\beamer@newcomopt#1#2[#3]#4{%
  \expandafter\def\expandafter#1\expandafter{\expandafter\beamer@presort\expandafter{\csname beamerx@\string#1\endcsname}{#2}{#3}}%
  \beamer@argscount=#2\relax%
  \advance\beamer@argscount by 1\relax%
  \expandafter\renewcommand\csname beamerx@\string#1\endcsname[\beamer@argscount]{#4}%
}
\renewcommand<>{\emph}[1]{{\only#2{\em}#1}}

\let\beamer@newcomnoopt=\beamer@orignewcomnoopt
\let\beamer@newcomopt=\beamer@orignewcomopt
\setbeamerfont{emphasis}{series=\bf,shape=\rm}

%>>
%<< [· Blocks ································] >>

%<< — macros{defineblock, defineblocks} · — >>

% \pgfkeys{/blocks/.is family}

\pgfkeys{/acme/blocks/.cd,
  alignbox/.is choice,
  alignbox/right/.code=
    \let\acmeblocksleft\@empty\let\acmeblocksright\hfill,
  alignbox/left/.code=
    \let\acmeblocksleft\hfill\let\acmeblocksright\@empty,
  alignbox/center/.code=
    \let\acmeblocksleft\hfill\let\acmeblocksright\hfill,
  alignbox/flushright/.style={alignbox=left},
  alignbox/flushleft/.style={alignbox=right}}

\def\blocksparameters{%
  width,
  align,
  color,
  % frame
  frame,
  customframe,
  background,
  custombackground,
  frameoptions,
  % title
  titleframe,
  titlecustomframe,
  titlebackground,
  titlecustombackground,
  titleoptions,
  titlecolor,
  titlestyle,
  titlealign,
  % body
  bodyframe,
  bodycustomframe,
  bodybackground,
  bodycustombackground,
  bodyoptions,
  bodycolor,
  bodystyle,
  bodyheight,
  bodyalign}

\def\defineblocks{\dodoubleempty\dodefineblocks}
\def\dodefineblocks[#1][#2]{%
  \iffirstargument
    \dodoubleargumentwithset\dodefineblock[#1][#2]
  \fi}

\def\defineblock{\dodoubleempty\dodefineblock}
\def\dodefineblock[#1][#2]{%
  \iffirstargument
    \def\current{#1}%
    \ifsecondargument
      \ifx\relax#2\relax% second argument supplied but empty
        \expanded{\copyrawparameters[\current block][blocks][\blocksparameters]}%
      \else
        \doifassignmentelse{#2}
          {\expanded{\copyrawparameters[\current block][blocks][\blocksparameters]}%
           \getrawparameters[\current block][#2]}
          {\expanded{\copyrawparameters[\current block][#2block][\blocksparameters]}}%
      \fi
    \else
      \expanded{\copyrawparameters[\current block][blocks][\blocksparameters]}%
    \fi
  \fi
  \expanded{\dodefineblockindeed
    {#1}
    {block \ifx\current\@empty\else\current\space\fi begin}
    {block \ifx\current\@empty\else\current\space\fi end}
    {block title\ifx\current\@empty\else\space\current\fi}
    {block body\ifx\current\@empty\else\space\current\fi}}}

%>>
%<< — macros{setupblock, setupblocks} ··· — >>

\def\setupblocks{\dodoubleempty\dosetupblocks}
\def\dosetupblocks[#1][#2]{%
  \ifsecondargument
    \dodoubleargumentwithset\dosetupblock[#1][#2]%
  \else
    \getrawparameters[blocks][#1]%
  \fi}

\def\setupblock{\dodoubleempty\dosetupblock}
\def\dosetupblock[#1][#2]{\getrawparameters[#1block][#2]}

%>>
%<< — macros{dodefineblockindeed} ······· — >>

%D One can define its own \dodefineblockindeed to whatever (s)he wishes.
%D It will be given 5 parameters:
%D   1. name of the block (\defineblock[name], use \begin{nameblock});
%D   2. name of the template put at the beginning (block begin);
%D   3. name of the template put at the end (block end);
%D   3. name of the template for the title (block title);
%D   3. name of the template for the body (block body).

\newbox\blocksbodybox
\newbox\blockstitlebox
\def\c@@default{default}

\def\dodefineblockindeed#1#2#3#4#5{%
  \def\current{#1}\ifx\current\c@@default\relax\let\current\@empty\fi%
  \@EA\edef\csname \current block\endcsname{%
    \noexpand\doifnextbgroupelse
      {\csname do\current block\endcsname}
      {\csname do\current block\endcsname{}}}%
  \@EA\long\@EA\edef\csname do\current block\endcsname##1{%
    \noexpand\doifnextoptionalelse
      {\csname dodo\current block\endcsname{\noexpand##1}}
      {\csname dodo\current block\endcsname{\noexpand##1}[]}}%
  \@EA\long\@EA\def\csname dodo\current block\endcsname##1[##2]{%
    \begingroup%
    \raggedright%
    \setupblock[#1][##2]%
    % [·adjust size of text: width, height & depth·]
    \evalasdimen\blockswd{\getvalue{#1blockwidth}}
    \setbeamercolor{item}{use=#1blockitems, fg=#1blockitems.fg}%
    \def\insertblocktitle{##1}%
    % [·let's go for the definition of a block·]
    \usefgorcolor{\getvalue{#1blockcolor}}%
    \expanded{\pgfkeys{/acme/framed/.cd, offset=0pt,
        \getvalue{#1blockframeoptions}}}%
    % [·the body first·]
    \setbox\nextbox=\vbox\bgroup
      \expanded{\begin{framedtext}
          [width=\blockswd-\acmeframedleftoffset-\acmeframedrightoffset,
           height=\getvalue{#1blockbodyheight},
           offset=0pt, maxheight=\paperheight,
           align={\getvalue{#1blockbodyalign}},
           \getvalue{#1blockbodyoptions}},
           customframe=\getvalue{#1blockbodycustomframe},
           custombackground=\getvalue{#1blockbodycustombackground},
           frame=on, background=on]
          \vskip-\parskip
          \usefgorcolor{\getvalue{#1blockbodycolor}}%
          \getvalue{#1blockbodystyle}\ignorespaces}%
  \@EA\def\csname end\current block\endcsname{%
    \end{framedtext}\egroup%
    % [·alignment·]
    \pgfkeys{/acme/blocks/.cd, alignbox=\getvalue{#1blockalign}}%
    \setbox\blocksbodybox=\box\nextbox
    % [·then the title·]
    \expanded{\pgfkeys{/acme/framed/.cd, \getvalue{#1blockframeoptions}}}%
    \setbox\blockstitlebox=\vbox\bgroup
      \hsize=\blockswd
      \ifx\insertblocktitle\@empty\else
        \expanded{\begin{framedtext}
          [width=\hsize-\acmeframedleftoffset-\acmeframedrightoffset,
           align={\getvalue{#1blocktitlealign}},
           offset=0pt, \getvalue{#1blocktitleoptions}},
           customframe=\getvalue{#1blocktitlecustomframe},
           custombackground=\getvalue{#1blocktitlecustombackground},
           frame=on, background=on]
          \parskip=0pt
          \usefgorcolor{\getvalue{#1blocktitlecolor}}%
          \getvalue{#1blocktitlestyle}%
          \insidestrut\insertblocktitle
         \end{framedtext}\fi
    \egroup
    % [·and the whole box·]
    \vrule width0pt\acmeblocksleft
    \expanded{\begin{framedtext}
        [width=\blockswd, offset=0pt, \getvalue{#1blockframeoptions}},
         customframe=\getvalue{#1blockcustomframe},
         custombackground=\getvalue{#1blockcustombackground},
         frame=on, background=on]
        \hsize=\blockswidth
        \vskip-\parskip\box\blockstitlebox
        \ifx\insertblocktitle\@empty\else\vskip-\parskip\fi
        \box\blocksbodybox
     \end{framedtext}%
   \acmeblocksright\vrule width0pt
   \endgroup}}

%>>

\def\fixvspace{\blank[-1*line, -1*half]}

\let\block\relax
\let\alertblock\relax
\let\exampleblock\relax

%>>
%<< [· Items ·································] >>

% prevent babel french.ldf from meddling with my itemizes
\AtBeginDocument{%
  \ifx\iflanguage\undefined\else
    \iflanguage{french}{\frenchbsetup{StandardLists=true}
  \fi}{}}

\def\usesquareitems{%
  \setbeamertemplate{itemize item}
    {\unitsquare[draw, scale=5, yshift=.2]}
  \setbeamertemplate{itemize subitem}
    {\unitsquare[draw, scale=4, yshift=.25]}
  \setbeamertemplate{itemize subsubitem}
    {\unitsquare[draw, scale=3, yshift=.3333]}}

\def\usecircleitems{%
  \setbeamertemplate{itemize item}
    {\unitcircle[draw, scale=5, yshift=.2]}
  \setbeamertemplate{itemize subitem}
    {\unitcircle[draw, scale=4, yshift=.25]}
  \setbeamertemplate{itemize subsubitem}
    {\unitcircle[draw, scale=3, yshift=.3333]}}

\def\usetriangleitems{%
  \setbeamertemplate{itemize item}
    {\unittriangle[draw, scale=5, yshift=.2]}
  \setbeamertemplate{itemize subitem}
    {\unittriangle[draw, scale=4, yshift=.25]}
  \setbeamertemplate{itemize subsubitem}
    {\unittriangle[draw, scale=3, yshift=.3333]}}

\def\usefilledsquareitems{%
  \setbeamertemplate{itemize item}
    {\unitsquare[fill, scale=5, yshift=.2]}
  \setbeamertemplate{itemize subitem}
    {\unitsquare[fill, scale=4, yshift=.25]}
  \setbeamertemplate{itemize subsubitem}
    {\unitsquare[fill, scale=3, yshift=.3333]}}

\def\usefilledcircleitems{%
  \setbeamertemplate{itemize item}
    {\unitcircle[fill, scale=5, yshift=.2]}
  \setbeamertemplate{itemize subitem}
    {\unitcircle[fill, scale=4, yshift=.25]}
  \setbeamertemplate{itemize subsubitem}
    {\unitcircle[fill, scale=3, yshift=.3333]}}

\def\usefilledtriangleitems{%
  \setbeamertemplate{itemize item}
    {\unittriangle[fill, scale=5, yshift=.2]}
  \setbeamertemplate{itemize subitem}
    {\unittriangle[fill, scale=4, yshift=.25]}
  \setbeamertemplate{itemize subsubitem}
    {\unittriangle[fill, scale=3, yshift=.3333]}}

%>>
%<< [· Enumerate ·····························] >>

\setbeamertemplate{enumerate item}{\insertenumlabel.}

% Patch to reset the counter on each enumerate
\def\beamer@enum@{%
  \csname c@\@enumctr\endcsname0% QUICKFIX strange bug, don't reset the counter
  \beamer@computepref\@itemdepth% sets \beameritemnestingprefix
  \usebeamerfont{itemize/enumerate \beameritemnestingprefix body}%
  \usebeamercolor[fg]{itemize/enumerate \beameritemnestingprefix body}%
  \usebeamertemplate{itemize/enumerate \beameritemnestingprefix body begin}%
  \expandafter
    \list
      {\usebeamertemplate{\beamer@enumtempl}}
      {\usecounter\@enumctr%
        \def\makelabel##1{{\hss\llap{{%
                \usebeamerfont*{enumerate \beameritemnestingprefix item}%
                \usebeamercolor[fg]{enumerate \beameritemnestingprefix item}##1}}}}}%
  \beamer@cramped%
  \raggedright%
  \beamer@firstlineitemizeunskip%
}

%>>

\setbeamersize{text margin left=1em, text margin right=1em}

%<< [· Basic templates ·······················] >>

%<< — helpers ············ — >>

\def\acme@template@complex#1{\@ifnextchar[{\doacme@template@complex{#1}}{\doacme@template@complex{#1}[#1]}}
\def\doacme@template@complex#1[#2]#3#4#5#6{
  \defbeamertemplate*{#1}{acme}{%
    #5{\usebeamerfont{#1}\usebeamercolor[fg]{#1}#3\csname insert#2\endcsname#4}#6}}

\def\acme@template@simple#1{\@ifnextchar[{\doacme@template@simple{#1}}{\doacme@template@simple{#1}[#1]}}
\def\doacme@template@simple#1[#2]{\acme@template@complex{#1}[#2]{}{}{}{}}

%>>

% titlepage templates
\acme@template@simple{institute}
\acme@template@simple{title}
\acme@template@simple{subtitle}
\acme@template@simple{author}
\acme@template@simple{date}

% head/footline templates
% {#1}=beamer template name,
% [#2]=used in \insert#2, defaults to #1 if not given.
\acme@template@simple{section in head/foot}[section]
\acme@template@simple{subsection in head/foot}[subsection]
\acme@template@simple{title in head/foot}[shorttitle]
\acme@template@simple{subtitle in head/foot}[shortsubtitle]
\acme@template@simple{author in head/foot}[shortauthor]
\acme@template@simple{date in head/foot}[shortdate]

\setbeamertemplate{navigation symbols}{}
\defbeamertemplate*{navigation symbols in head/foot}{acme}{%
  {\usebeamerfont{navigation symbols in head/foot}
    \usebeamercolor[fg]{navigation symbols in head/foot}
    \insertslidenavigationsymbol \insertframenavigationsymbol
    \insertsubsectionnavigationsymbol \insertsectionnavigationsymbol
    \insertdocnavigationsymbol \insertbackfindforwardnavigationsymbol}}

% table of contents templates
% {#1}=beamer template name,
% [#2]=used in \insert#2, defaults to #1 if not given,
% {#3}=before \insert___, {#4}=after \insert___, typeset with
%                                                color and font of #1
% {#5}=before \insert___ and #3, {#6}=after \insert___ and #4,
%                                    typeset with current color and font
\acme@template@complex{section in toc}[tocsection]%
  {}{}
  {\vskip12pt plus6pt minus6pt\leavevmode\usebeamertemplate{itemize item}\hskip\labelsep}{}
\acme@template@complex{subsection in toc}[tocsubsection]%
  {}{}
  {\vskip3pt plus3pt minus3pt\leavevmode\hskip\leftmarginii
    \usebeamertemplate{itemize subitem}\hskip\labelsep}{\endgraf}

%>>
%<< [· Enhanced itemizes: sitemize ···········] >>

\def\sitemize{%
  \doifnextoptionalelse
    {\dositemize}
    {\dositemize[1]}}
\def\dositemize[#1]{%
  \doifnextoptionalelse
    {\dodositemize[#1]}
    {\dodositemize[#1][]}}
\def\dodositemize[#1][#2]{%
  \begingroup
  \advance\@itemdepth by -1
  \advance\@itemdepth by #1
  \begin{itemize}[#2]}

\def\endsitemize{%
  \end{itemize}
  \endgroup}

%>>
%<< [· Highlighting text ·····················] >>

\usetikzlibrary[fit]

\pgfdeclarelayer{background}
\pgfsetlayers{background,main}

\tikzset{hl/.style=
  {overlay, sharp corners, fill=green!35,
    very thick, inner xsep=1pt, inner ysep=2pt}}

\newcommand<>\hl[2][]{%
  \ifmmode \setbox0=\hbox{\ensuremath{#2}}
  \else    \setbox0=\hbox{#2}\fi \dp0=0pt
  \begin{tikzpicture}[remember picture]
    \node[inner sep=0pt] (mark) {\box0};
    \only#3
      {\begin{pgfonlayer}{background}
         \node[hl, #1, fit=(mark)] {};
       \end{pgfonlayer}}
  \end{tikzpicture}}

\newcommand\placehlmark[2][mark]{%
  \ifmmode \setbox0=\hbox{\strut\ensuremath{#2}}
  \else    \setbox0=\hbox{\strut#2}\fi \dp0=0pt
  \begin{tikzpicture}[remember picture]
    \node[anchor=text, inner sep=0pt] (#1) {\box0};
  \end{tikzpicture}}

\newcommand<>\hlmarks[2][ellipse]{%
  \begin{tikzpicture}[remember picture, overlay]
    \only#3{\node [draw=darkorange, line width=1.6pt, #1, fit=#2] {};}
  \end{tikzpicture}}

%>>

%% Below we propose a default theme

%<< [··· colors      ···] >>

%<< — helpers ············ — >>

\def\usefgorcolor#1{%
  \ifbeamercolorempty[fg]{#1}%
  {\definecolor{fg}{named}{#1}\color{#1}}%
  {\usebeamercolor[fg]{#1}}}

\def\useordefinefgbgcolor#1{%
  \ifbeamercolorempty[fg]{#1}%
  {\definecolor{fg}{named}{#1}\definecolor{bg}{named}{bg}}%
  {\usebeamercolor{#1}}}

%>>

% color definitions
\definecolor{nearlyblack}{RGB}{17,11,4}
\definecolor{nearlywhite}{RGB}{253,252,254}
\definecolor{darkorange}{RGB}{188,90,18}
\definecolor{solidblue}{RGB}{9,51,106}
\definecolor{softgray}{RGB}{105,105,105}
\definecolor{darkyellow}{rgb}{.95,.95,.85}

% additional colors
\colorlet{darkgreen}{green!60!black}
\colorlet{darkred}{red!60!black}

% general definitions
\def\plain@colors{
  \setbeamercolor{normal text}
    {fg=gray!30!black,bg=gray!3}
  \setbeamercolor{structure}
    {fg=solidblue!80!gray,bg=solidblue!80!gray!5}

  \setbeamercolor{alerted text}
    {fg=red!60!black, bg=red!60!black!5}
  \setbeamercolor{example text}
    {fg=green!40!black, bg=green!40!black!5}
  \setbeamercolor{emphasis}
    {fg=darkorange, bg=darkorange!5}

  \setbeamercolor{background canvas}{parent=normal text}
  \setbeamercolor{background}{parent=background canvas}

  \setbeamercolor{palette primary}{use=structure,fg=structure.fg}
  \setbeamercolor{palette secondary}{use=structure,fg=structure.fg!75!black}
  \setbeamercolor{palette tertiary}{use=structure,fg=structure.fg!50!black}
  \setbeamercolor{palette quaternary}{fg=gray!65!black}

  \setbeamercolor{palette sidebar primary}{use=normal text,fg=normal text.fg}
  \setbeamercolor{palette sidebar secondary}{use=structure,fg=structure.fg}
  \setbeamercolor{palette sidebar tertiary}{use=normal text,fg=normal text.fg}
  \setbeamercolor{palette sidebar quaternary}{use=structure,fg=structure.fg}

  \setbeamercolor{math text}{}
  \setbeamercolor{math text inlined}{parent=math text}
  \setbeamercolor{math text displayed}{parent=math text}

  \setbeamercolor{normal text in math text}{}

  \setbeamercolor{local structure}{parent=palette quaternary}

  \setbeamercolor{titlelike}{parent=structure}

  \setbeamercolor{headline}{fg=black}
  \setbeamercolor{footline}{parent=headline}

  \setbeamercolor{title}{parent=titlelike}
  \setbeamercolor{title in head/foot}{parent=headline}
  \setbeamercolor{title in sidebar}{parent=palette sidebar quaternary}

  \setbeamercolor{subtitle}{parent=title}
  \setbeamercolor{subtitle in head/foot}{parent=title in head/foot}

  \setbeamercolor{author}{fg=gray!45!black}
  \setbeamercolor{author in head/foot}{parent=headline}
  \setbeamercolor{author in sidebar}{use=palette sidebar tertiary,fg=palette sidebar tertiary.fg}

  \setbeamercolor{institute}{fg=gray!25!black}
  \setbeamercolor{institute in head/foot}{parent=headline}
  \setbeamercolor{institute in sidebar}{use=palette sidebar tertiary,fg=palette sidebar tertiary.fg}

  \setbeamercolor{date}{parent=author}
  \setbeamercolor{date in head/foot}{parent=headline}
  \setbeamercolor{date in sidebar}{use=palette sidebar tertiary,fg=palette sidebar tertiary.fg}

  \setbeamercolor{titlegraphic}{}

  \setbeamercolor{part name}{}
  \setbeamercolor{part title}{parent=titlelike}

  \setbeamercolor{section name}{}
  \setbeamercolor{section title}{parent=titlelike}

  \setbeamercolor{section in toc}{parent=structure}
  \setbeamercolor{section in toc shaded}{parent=section in toc}
  \setbeamercolor{section in head/foot}{parent=headline}
  \setbeamercolor{section in sidebar}{parent=palette sidebar secondary}
  \setbeamercolor{section in sidebar shaded}{use=section in sidebar,fg=section in sidebar.fg!40!bg}
  \setbeamercolor{section number projected}{parent=item projected}

  \setbeamercolor{subsection name}{}
  \setbeamercolor{subsection title}{parent=titlelike}

  \setbeamercolor{subsection in toc}{parent=local structure}
  \setbeamercolor{subsection in toc shaded}{parent=subsection in toc}
  \setbeamercolor{subsection in head/foot}{parent=headline}
  \setbeamercolor{subsection in sidebar}{parent=palette sidebar primary}
  \setbeamercolor{subsection in sidebar shaded}{use=subsection in sidebar,fg=subsection in sidebar.fg!40!bg}
  \setbeamercolor{subsection number projected}{parent={subitem projected}}

  \setbeamercolor{subsubsection in toc}{parent=subsection in toc}
  \setbeamercolor{subsubsection in toc shaded}{parent=subsubsection in toc}
  \setbeamercolor{subsubsection in head/foot}{parent=headline}
  \setbeamercolor{subsubsection in sidebar}{parent=subsection in sidebar}
  \setbeamercolor{subsubsection in sidebar shaded}{parent=subsection in sidebar shaded}
  \setbeamercolor{subsubsection number projected}{parent=subsubitem projected}

  \setbeamercolor{sidebar}{}
  \setbeamercolor{sidebar left}{parent=sidebar}
  \setbeamercolor{sidebar right}{parent=sidebar}

  \setbeamercolor{logo}{parent=palette secondary}

  \setbeamercolor{frametitle}{parent=titlelike}
  \setbeamercolor{framesubtitle}{parent=frametitle}

  \setbeamercolor{frametitle right}{parent=frametitle}
  \setbeamercolor{mini frame}{fg=structure.fg, bg=black!50}

  \setbeamercolor{caption}{}
  \setbeamercolor{caption name}{parent=structure}

  \setbeamercolor{button}{use=local structure,bg=local structure.fg!50!bg,fg=white}
  \setbeamercolor{button border}{use=button,fg=button.bg}
  \setbeamercolor{navigation symbols}{use=local structure,fg=local structure.fg!40!bg}
  \setbeamercolor{navigation symbols dimmed}{use=local structure,fg=local structure.fg!20!bg}
  \setbeamercolor{mini frame}{parent=section in head/foot}

  \setbeamercolor{block body}{parent=normal text}
  \setbeamercolor{block body alerted}{parent=normal text}
  \setbeamercolor{block body example}{parent=normal text}
  \setbeamercolor{block title}{parent=structure}
  \setbeamercolor{block title alerted}{parent=alerted text}
  \setbeamercolor{block title example}{parent=example text}

  \setbeamercolor{item}{parent=structure}
  \setbeamercolor{subitem}{parent=item}
  \setbeamercolor{subsubitem}{parent=subitem}

  \setbeamercolor{item projected}{parent=item,use=item,fg=white,bg=item.fg}
  \setbeamercolor{subitem projected}{parent=item projected}
  \setbeamercolor{subsubitem projected}{parent=subitem projected}

  \setbeamercolor{enumerate item}{parent=item}
  \setbeamercolor{enumerate subitem}{parent=subitem}
  \setbeamercolor{enumerate subsubitem}{parent=subsubitem}

  \setbeamercolor{itemize item}{parent=item}
  \setbeamercolor{itemize subitem}{parent=subitem}
  \setbeamercolor{itemize subsubitem}{parent=subsubitem}

  \setbeamercolor{itemize/enumerate body}{}
  \setbeamercolor{itemize/enumerate subbody}{}
  \setbeamercolor{itemize/enumerate subsubbody}{}

  \setbeamercolor{description item}{parent=item}

  \setbeamercolor{bibliography item}{parent=item}

  \setbeamercolor{bibliography entry author}{use=structure,fg=structure.fg}
  \setbeamercolor{bibliography entry title}{use=normal text,fg=normal text.fg}
  \setbeamercolor{bibliography entry location}{use=structure,fg=structure.fg!65!bg}
  \setbeamercolor{bibliography entry note}{use=structure,fg=structure.fg!65!bg}

  \setbeamercolor{separation line}{}

  \setbeamercolor{upper separation line head}{parent=separation line}
  \setbeamercolor{middle separation line head}{parent=separation line}
  \setbeamercolor{lower separation line head}{parent=separation line}

  \setbeamercolor{upper separation line foot}{parent=separation line}
  \setbeamercolor{middle separation line foot}{parent=separation line}
  \setbeamercolor{lower separation line foot}{parent=separation line}

  \setbeamercolor{abstract}{}
  \setbeamercolor{abstract title}{parent=structure}

  \setbeamercolor{verse}{}

  \setbeamercolor{quotation}{}
  \setbeamercolor{quote}{parent=quotation}

  \setbeamercolor{page number in head/foot}{parent=headline, fg=black}

  \setbeamercolor{qed symbol}{parent=structure}

  % personnal additions
  \setbeamercolor{big box}{parent=structure}
  \setbeamercolor{title box}{parent=big box}
  \setbeamercolor{frametoc}{parent=structure}
}

%>>
%<< [··· fonts       ···] >>

\def\plain@fonts{
  \setbeamerfont{normal text}{size=\normalsize}
  \parskip=1\baselineskip plus.5\baselineskip minus.5\baselineskip
  % \parskip=.5\baselineskip plus1fill minus.5\baselineskip
  \setbeamerfont{emphasis}{series=\bfseries}

  \setbeamerfont{alerted text}{series=\bfseries}
  \setbeamerfont{example text}{}

  \setbeamerfont{structure}{series=\bfseries}
  \setbeamerfont{tiny structure}{size=\tiny}

  \setbeamerfont{headline}{parent={tiny structure}, size=\Tiny,shape=\scshape}
  \setbeamerfont{footline}{parent={headline}}

  \setbeamerfont{title}{size=\large,shape=\scshape,series=\bfseries}
  \setbeamerfont{title in head/foot}{}
  \setbeamerfont{title in sidebar}{size=\tiny}

  \setbeamerfont{subtitle}{parent=title,size=\footnotesize}
  \setbeamerfont{subtitle in head/foot}{parent=title in head/foot}

  \setbeamerfont{author}{size=\tiny}
  \setbeamerfont{author in head/foot}{}
  \setbeamerfont{author in sidebar}{size=\tiny}

  \setbeamerfont{institute}{size=\tiny}
  \setbeamerfont{institute in head/foot}{}
  \setbeamerfont{institute in sidebar}{}

  \setbeamerfont{date}{size=\tiny}
  \setbeamerfont{date in head/foot}{}
  \setbeamerfont{date in sidebar}{}

  \setbeamerfont{part name}{size=\LARGE}
  \setbeamerfont{part title}{size=\LARGE,parent=title}

  \setbeamerfont{section name}{size=\Large}
  \setbeamerfont{section title}{size=\Large,parent=title}

  \setbeamerfont{section in toc}{parent=structure}
  \setbeamerfont{section in toc shaded}{parent=section in toc}
  \setbeamerfont{section in head/foot}{}
  \setbeamerfont{section in sidebar}{size=\tiny}
  \setbeamerfont{section number projected}{size=\small,parent={section in toc,projected text}}

  \setbeamerfont{subsection name}{size=\large}
  \setbeamerfont{subsection title}{size=\large,parent=title}

  \setbeamerfont{subsection in toc}{size=\small}
  \setbeamerfont{subsection in toc shaded}{parent=subsection in toc}
  \setbeamerfont{subsection in head/foot}{}
  \setbeamerfont{subsection in sidebar}{}

  \setbeamerfont{subsubsection in toc}{size=\footnotesize}

  \setbeamerfont{subsubsection in toc shaded}{parent=subsubsection in toc}
  \setbeamerfont{subsubsection in head/foot}{}
  \setbeamerfont{subsubsection in sidebar}{}

  \setbeamerfont{sidebar}{size=\Tiny,parent={tiny structure}}
  \setbeamerfont{sidebar left}{parent=sidebar}
  \setbeamerfont{sidebar right}{parent=sidebar}

  \setbeamerfont{frametitle}{parent=structure,size=\Large,shape=\scshape,series=\bfseries}
  \setbeamerfont{framesubtitle}{parent=frametitle,size=\normalsize}

  \setbeamerfont{caption}{size=\small}
  \setbeamerfont{caption name}{parent={structure,caption}}

  \setbeamerfont{button}{size=\tiny}

  \setbeamerfont{block body}{}
  \setbeamerfont{block body alerted}{}
  \setbeamerfont{block body example}{}
  \setbeamerfont{block title}{size=\large,parent={structure,block body}}
  \setbeamerfont{block title alerted}{parent={block title,alerted text}}
  \setbeamerfont{block title example}{parent={block title,example text}}
  \setbeamerfont{block title example}{parent={block title,example text}}

  \setbeamerfont{item}{parent=structure, size=\footnotesize, shape=\scshape}
  \setbeamerfont{subitem}{parent=item}
  \setbeamerfont{subsubitem}{parent=subitem}

  \setbeamerfont{item projected}{size=\tiny,parent={item,projected text}}
  \setbeamerfont{subitem projected}{parent=item projected}
  \setbeamerfont{subsubitem projected}{parent=subitem projected}

  \setbeamerfont{itemize item}{parent=item}
  \setbeamerfont{itemize subitem}{parent=subitem}
  \setbeamerfont{itemize subsubitem}{parent=subsubitem}

  \setbeamerfont{enumerate item}{parent=item}
  \setbeamerfont{enumerate subitem}{parent=subitem}
  \setbeamerfont{enumerate subsubitem}{parent=subsubitem}

  \setbeamerfont{itemize/enumerate body}{parent=normal text}
  \setbeamerfont{itemize/enumerate subbody}{parent=itemize/enumerate body}
  \setbeamerfont{itemize/enumerate subsubbody}{parent=itemize/enumerate subbody}

  \setbeamerfont{description item}{parent=item}

  \setbeamerfont{projected text}{parent={tiny structure}}

  \setbeamerfont{abstract}{size=\small}
  \setbeamerfont{abstract title}{parent={abstract,structure},size=\normalsize}

  \setbeamerfont{verse}{family=\rmfamily,shape=\itshape}

  \setbeamerfont{quotation}{shape=\itshape}
  \setbeamerfont{quote}{parent=quotation}

  \setbeamerfont{note page}{size=\small}
}

%>>
%<< [··· definitions ···] >>

% [·page numbers·]
\setuppagenumbers[style=plain]

% [·headline·]
\setupheadline[%
  left=title,
  right=page numbers,
  frame={%
    width=\hsize,
    leftmargin=\leftmargin,
    rightmargin=\rightmargin,
    topmargin=2pt,
    bottommargin=0pt}]

% [·footline·]
\setupfootline[%
  left=empty,
  center=empty,
  right=empty,
  frame={
    width=\hsize,
    leftmargin=\leftmargin,
    rightmargin=\rightmargin,
    topmargin=0pt,
    bottommargin=1pt}]

% [·blocks·]
\defineblock [default] [color=structure]
\defineblock [alert]   [color=alerted text]
\defineblock [example] [color=example text]

\setbeamercolor{defaultblockitems}{parent=structure}%, fg=structure.fg!70}
\setbeamercolor{alertblockitems}{parent=alerted text}%, fg=alerted text.fg!70}
\setbeamercolor{exampleblockitems}{parent=example text}%, fg=example text.fg!70}

\let\defaultblock\block
\let\defaultendblock\endblock

% Another handy one
\defineblock [emphasis] [color=emphasis]
\setbeamercolor{emphasisblockitems}{parent=emphasis}

%% TODO: use append instead of rewrite
\setupblocks[%
  width=\hsize,
  align=center,
  % [·outer frame·]
  customframe=
    {\path [draw] (0,0) rectangle ++(\framedboxwd,-\framedboxht);},
  custombackground=
    {\path [fill] (0,0) rectangle ++(\framedboxwd,-\framedboxht);},
  frameoptions=
    {offset=0pt,
     tikzoptions={draw=fg, fill=bg, thick, rounded corners=2pt}},
  % [·title·]
  titlecustomframe=none,
  titlecustombackground=
    {\path [fill=fg]
    {[sharp corners] (0,0) -- ++(0,-\framedboxht) -- ++(\framedboxwd,0)}
    {[rounded corners=2pt] -- ++(0,\framedboxht)  -- cycle};},
  titleoptions={offset=4pt, bottomoffset=2pt, left=\strut},
  titlecolor=white,
  titlestyle=\usebeamerfont{block title},
  titlealign={center},
  % [·body·]
  bodycustomframe=none,
  bodycustombackground=false,
  bodyoptions={offset=4pt},
  bodycolor=normal text,
  bodystyle=\usebeamerfont{block body},
  bodyheight=-\maxdimen,
  bodyalign={default, middle}]%

\let\oldsection\section
\def\section{\let\subsecname\@empty\oldsection}



\def\acmeplaintheme{%
  % [·fonts & colors·]
  \plain@fonts
  \plain@colors
  % [·head/footline·]
  \setbeamertemplate{headline}[acme]
  \setbeamertemplate{footline}[acme]
  % [·title page·]
  \setbeamertemplate{title page}[acme]{%
    \begin{tikzpicture}[remember picture, overlay]%
      %% thin line towards the bottom
      \begingroup
        \usebeamercolor{structure}
        \draw [color=fg, very thick]%
          ([xshift=\leftmargin, yshift=\acmetitlepagelineoffset]
            current page.south west)%
          coordinate (reference) -- ++(\hsize,0);
      \endgroup%
      %% tilegraphic above that line
      \node [anchor=south west, inner sep=0pt]%
        at ([yshift=2pt]reference)%
        {\usebeamer{institute}\inserttitlegraphic};%
      %% title(/subtitle) below that line
      \node [anchor=north west, inner sep=0pt]%
        at ([yshift=-2pt]reference)%
        {\vbox\bgroup
          \hbox{\usebeamer{title}\strut\inserttitle}%
          \ifx\insertsubtitle\@empty\else
            \hbox{\usebeamer{subtitle}\strut\insertsubtitle}\fi%
          \egroup};%
   \end{tikzpicture}}%
  % [·frametitle·]
  \setbeamertemplate{frametitle}[acme]{%
    \ifbeamer@plainframe\else
      \framed[frame=off, topframe=on, width=\hsize,
              offset=0pt, topoffset=2pt,
              tikzoptions={draw=fg, fill=normal text.bg, very thick}]%
      {\vbox\bgroup
         \hbox to \hsize{\usebeamer{frametitle}%
           \vrule width0pt height1.2\strutht
             \ifx\insertframetitle\@empty
               \ifx\subsecname\@empty
               \ifx\secname\@empty
               \else\secname\fi
               \else\subsecname\fi
             \else\insertframetitle\fi\hfil}
         \vskip-.15\baselineskip
         \hbox to \hsize{\usebeamer{framesubtitle}%
           \vrule width0pt height1.2\strutht depth\strutdp
           \insertframesubtitle\hfil}
       \egroup}\fi}
  % [·items·]
  \let\dododoitem\item
  \def\dodoitem{\dododoitem}
  \def\doitem{\dodoitem}
  \def\item{\afterassignment\doitem
    \parskip=.5\baselineskip minus.5\baselineskip}
  \setbeamertemplate{itemize item}
    {\unitsquare[fill, scale=5, rounded corners=1, yshift=.2]}
  \setbeamertemplate{itemize subitem}
    {\unittriangle[fill, scale=4, rounded corners=.2, yshift=.25]}
  \setbeamertemplate{itemize subsubitem}
    {\unittriangle[draw, scale=3, rounded corners=.2, yshift=.3333]}
}

%>>

\let\secname\@empty
\let\subsecname\@empty


%%% Local Variables:
%%% TeX-master: "./demo.tex"
%%% End:
