% Time-stamp: <2010-12-03 15:28:30 cmauclai>
%
% Copyright 2010 by Cedric Mauclair
%
% This file may be distributed and/or modified
%
% 1. under the CCPL Attribution-ShareAlike License
% (http://creativecommons.org/licenses/by-sa/3.0/legalcode) and/or
% 2. under the GNU Public License 3 (http://www.gnu.org/licenses/gpl.html).
%
% Created by Cedric Mauclair for the 'acme' themes.
%
% Version: 2.1
% Date:    2010-11-26

\ProvidesPackageRCS $Header: acme-beamer.sty,v 1.0 2010/10/10 18:00:00 acme Exp $


\typeout{}
\typeout{###################################}
\typeout{#}
\typeout{# Beamer theme ''acme-beamer'' (c) Cedric Mauclair, 2010}
\typeout{# + snippets from ''progressbar'' beamer theme (c) Sylvain Bouveret, 2009}
\typeout{# + snippets from ''leman'' beamer theme (c) David Chemouil, 2009}
\typeout{#}
\typeout{# Version: 1.0   [2009-12-15] First release}
\typeout{# Version: 1.0.1 [2010-01-04] Minor revision}
\typeout{# Version: 1.1   [2010-01-05] Added an optional argument to maketitle command}
\typeout{#                             Modified enumerate environment to pifont dings}
\typeout{# Version: 1.2   [2010-02-23] Added a custom to bigbox to do whatever you want}
\typeout{#                             Added the support for frame subtitles}
\typeout{# Version: 2.0   [2010-11-22] Huge rewrite. Using pgfkeys instead of xkeyval}
\typeout{# Version: 2.1   [2010-11-26] Rewrote framedtext environment}
\typeout{#}
\typeout{###################################}
\typeout{}


%<< Required packages >>

\RequirePackage{pgfkeys}
\RequirePackage[math]{iwona}
\RequirePackage{ifthen}
\RequirePackage{tikz}

\usetikzlibrary[patterns]
\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}

%>>
%<< Utils >>

\def\dosingleempty#1{\@ifnextchar[{#1}{#1[]}}

\def\definesetup#1{%
  \expandafter\def\csname setup#1\endcsname##1{\pgfkeys{/#1/.cd, ##1}}}

\def\usebeamer#1{%
  \usebeamerfont{#1}\usebeamercolor[fg]{#1}}

\pgfkeys{/handlers/.store as dimen/.code=%
  \pgfkeys{\pgfkeyscurrentpath/.code={#1=\dimexpr##1\relax}}}

%<< -- \getparameters à la ConTeXt >>

\def\getparameters[#1][#2]{%
  \def\acmedefroot{#1}%
  \pgfkeys{/def/.list={#2}}}

\def\acmeunpack#1=#2\acmestop{\def\acmekey{#1}\def\acmevalue{#2}}
\pgfkeys{/def/.code=%
  \acmeunpack#1\acmestop%
  \expandafter\let\csname \acmedefroot\acmekey\endcsname\acmevalue}

%>>
%<< -- boxit >>

\newbox\boxitbox
\newlength\boxitwd
\newlength\boxitht
\newlength\boxitlftoffset
\newlength\boxitrgtoffset
\newlength\boxittopoffset
\newlength\boxitbotoffset

\pgfkeys{/boxit/.is family}

\pgfkeys{/boxit,
  wd/.store as dimen=\boxitwd,
  ht/.store as dimen=\boxitht,
  %% —————————————————————————————————————————————————— %%
  lftoffset/.store as dimen=\boxitlftoffset,
  rgtoffset/.store as dimen=\boxitrgtoffset,
  topoffset/.store as dimen=\boxittopoffset,
  botoffset/.store as dimen=\boxitbotoffset,
  offset/.style={lftoffset=#1, rgtoffset=#1,
                 topoffset=#1, botoffset=#1},
  %% —————————————————————————————————————————————————— %%
  before/.store in=\boxitbefore,
  after/.store in=\boxitafter,
  above/.store in=\boxitabove,
  below/.store in=\boxitbelow}

\definesetup{boxit}

\def\doboxitnorules[#1]#2{%
  \setupboxit{wd=\hsize, ht=-1pt, offset=3pt,
    before=\noindent, after=\endgraf, above=\vfill, below=}%
  \setupboxit{#1}%
  %% —————————————————————————————————————————————————— %%
  \advance\boxitwd by -\boxitlftoffset%
  \advance\boxitwd by -\boxitrgtoffset%
  \setbox\boxitbox=\vbox{%
    \hsize=\boxitwd \boxitbefore#2\boxitafter}%
  \templena=\boxitht%
  \advance\templena by -\boxittopoffset%
  \advance\templena by -\boxitbotoffset%
  \raisebox{\dimexpr-\dp\boxitbox-\boxitbotoffset\relax}{\hbox{%
    \kern\boxitlftoffset%
    \vbox \ifdim\templena>0pt to\boxitht\fi {%
      \kern\boxittopoffset \boxitabove \unvbox\boxitbox \boxitbelow \kern\boxitbotoffset}%
    \kern\boxitrgtoffset}}}

\def\doboxitrules[#1]#2{%
  \pgfkeys{/boxit, wd=.3\hsize, ht=-1pt, offset=3pt,
    before=\noindent, after=\endgraf, above=\vfill, below=}%
  \pgfkeys{/boxit, #1}%
  %% —————————————————————————————————————————————————— %%
  \advance\boxitwd by -\boxitlftoffset%
  \advance\boxitwd by -\boxitrgtoffset%
  \setbox\boxitbox=\vbox{%
    \hsize=\boxitwd \boxitbefore#2\boxitafter}%
  \templena=\boxitht%
  \advance\templena by -\boxittopoffset%
  \advance\templena by -\boxitbotoffset%
  \raisebox{\dimexpr-\dp\boxitbox-\boxitbotoffset\relax}{\hbox{\vbox{\hrule%
    \hbox{\vrule%
      \kern\boxitlftoffset%
      \vbox \ifdim\templena>0pt to\boxitht\fi {%
        \kern\boxittopoffset \boxitabove \unvbox\boxitbox \boxitbelow \kern\boxitbotoffset}%
      \kern\boxitrgtoffset\vrule}\hrule}\ignorespaces}}}

\def\boxit{\dosingleempty\doboxit}
\let\doboxit\doboxitnorules

\def\ruleit{\dosingleempty\doruleit}
\let\doruleit\doboxitrules

%>>
%<< -- framed >>

\newbox\framedbox
\newlength\framedwd
\newlength\framedminwd
\newlength\framedmaxwd
\newlength\framedht
\newlength\framedminht
\newlength\framedlftmargin
\newlength\framedrgtmargin
\newlength\framedtopmargin
\newlength\framedbotmargin
\newlength\framedlftoffset
\newlength\framedrgtoffset
\newlength\framedtopoffset
\newlength\framedbotoffset

\pgfkeys{/framed/.is family}

\pgfkeys{/framed,
  width/.store as dimen=\framedwd,
  minimum width/.store as dimen=\framedminwd,
  maximum width/.store as dimen=\framedmaxwd,
  height/.store as dimen=\framedht,
  minimum height/.store as dimen=\framedminht,
  %% —————————————————————————————————————————————————— %%
  left margin/.store as dimen=\framedlftmargin,
  right margin/.store as dimen=\framedrgtmargin,
  top margin/.store as dimen=\framedtopmargin,
  bottom margin/.store as dimen=\framedbotmargin,
  margin/.style={lmargin=#1, rmargin=#1, tmargin=#1, bmargin=#1},
  %% —————————————————————————————————————————————————— %%
  left offset/.store as dimen=\framedlftoffset,
  right offset/.store as dimen=\framedrgtoffset,
  top offset/.store as dimen=\framedtopoffset,
  bottom offset/.store as dimen=\framedbotoffset,
  offset/.style={loffset=#1, roffset=#1, toffset=#1, boffset=#1},
  %% —————————————————————————————————————————————————— %%
  halign/.is choice,
  halign/left/.style={/framed, before=\raggedright, after=\endgraf},
  halign/right/.style={/framed, before=\raggedleft, after=\endgraf},
  halign/center/.style={/framed, before=\centering, after=\endgraf},
  %% —————————————————————————————————————————————————— %%
  halignbox/.is choice,
  halignbox/left/.style={/framed, before=\raggedright, after=\endgraf},
  halignbox/right/.style={/framed, before=\raggedleft, after=\endgraf},
  halignbox/center/.style={/framed, before=\centering, after=\endgraf},
  %% —————————————————————————————————————————————————— %%
  valign/.is choice,
  valign/top/.style={/framed, above=, below=\vfill},
  valign/bottom/.style={/framed, above=\vfill, below=},
  valign/center/.style={/framed, above=\vfill, below=\vfill},
  %% —————————————————————————————————————————————————— %%
  before/.store in=\framedbefore, after/.store in=\framedafter,
  above/.store in=\framedabove,   below/.store in=\framedbelow,
  %% —————————————————————————————————————————————————— %%
  left frame/.is choice,
  left frame/off/.code=\let\framedleftframe\@empty,
  left frame/on/.code=\def\framedleftframe{%
      \path [draw] (0,0) -- ++(0,-\framedht);},
  %%
  right frame/.is choice,
  right frame/off/.code=\let\framedrightframe\@empty,
  right frame/on/.code=\def\framedrightframe{%
      \path [draw] (\framedwd,0) -- ++(0,-\framedht);},
  %%
  top frame/.is choice,
  top frame/off/.code=\let\framedtopframe\@empty,
  top frame/on/.code=\def\framedtopframe{%
      \path [draw] (0,0) -- ++(\framedwd,0);},
  %%
  bottom frame/.is choice,
  bottom frame/off/.code=\let\framedbottomframe\@empty,
  bottom frame/on/.code=\def\framedbottomframe{%
      \path [draw] (0,-\framedht) -- ++(\framedwd,0);},
  %%
  frame/.style={lframe=#1, rframe=#1, tframe=#1, bframe=#1},
  customframe/.code=\def\framedframe{#1},
  customframe/.add style={}{frame=off},
  background/.is choice, background/.default=yes,
  background/yes/.code=\framedbackground@default,
  background/no/.code=\let\framedbackground\@empty,
  background/none/.link=/background/no,
  custombackground/.code=\def\framedbackground{#1},
  %% —————————————————————————————————————————————————— %%
  options/.estore in=\framedoptions,
  %% —————————————————————————————————————————————————— %%
  lmargin/.style={left margin=#1},
  rmargin/.style={right margin=#1},
  tmargin/.style={top margin=#1},
  bmargin/.style={bottom margin=#1},
  %%
  loffset/.style={left offset=#1},
  roffset/.style={right offset=#1},
  toffset/.style={top offset=#1},
  boffset/.style={bottom offset=#1},
  %%
  lframe/.style={left frame=#1},
  rframe/.style={right frame=#1},
  tframe/.style={top frame=#1},
  bframe/.style={bottom frame=#1},
}

\definesetup{framed}

\let\framedframe\@empty%
\let\framedbackground\@empty%

\def\framedbackground@default{%
  \def\framedbackground{%
    \path [fill] (0,0) rectangle ++(\framedwd,-\framedht);}}

\def\framed{\dosingleempty\doframed}
\def\doframed[#1]#2{\begingroup%
  \pgfkeysfiltered{/framed, width=-1pt,
    minimum width=-\maxdimen+10pt, maximum width=\hsize,
    height=-1pt, minimum height=-\maxdimen+10pt,
    margin=0pt, offset=3pt, before=, after=, above=, below=,
    frame=on, background=none, options={draw=fg,fill=bg,rounded corners}}%
  %% —————————————————————————————————————————————————— %%
  \pgfkeysfiltered{/framed, #1}%
  %% —————————————————————————————————————————————————— %%
  % did we specified a width? if not, use the natural width
  \ifdim\framedwd<0pt
    \setbox\framedbox=\hbox{#2}%
    \framedwd=\wd\framedbox
    \advance\framedwd by\framedlftoffset
    \advance\framedwd by\framedrgtoffset
  \fi
  \ifdim\framedwd<\framedminwd \framedwd=\framedminwd\fi
  \ifdim\framedwd>\framedmaxwd \framedwd=\framedmaxwd\fi
  \setbox\framedbox=\vbox{%
  \boxit[wd=\framedwd, ht=\framedht,
         lftoffset=\framedlftoffset, rgtoffset=\framedrgtoffset,
         topoffset=\framedtopoffset, botoffset=\framedbotoffset,
         before=\framedbefore, after=\framedafter,
         above=\framedabove,   below=\framedbelow]{#2}}%
  \framedht=\ht\framedbox%
  \advance\framedht by \dp\framedbox%
  %% —————————————————————————————————————————————————— %%
  \ifx\framedleftframe\@empty\else%
  \ifx\framedrightframe\@empty\else%
  \ifx\framedtopframe\@empty\else%
  \ifx\framedbottomframe\@empty\else%
  \ifx\framedframe\@empty%
    \let\framedleftframe\@empty%
    \let\framedrightframe\@empty%
    \let\framedtopframe\@empty%
    \let\framedbottomframe\@empty%
    \def\framedframe{%
      \path [draw] (0,0) rectangle ++(\framedwd,-\framedht);}%
  \fi\fi\fi\fi\fi%
  %% —————————————————————————————————————————————————— %%
  \setbox\framedbox=\hbox{%
  \expandafter\tikzpicture\expandafter[\framedoptions]%
    \path [use as bounding box] (0,0) rectangle ++(\framedwd,-\framedht);
    \framedbackground
    \framedleftframe
    \framedrightframe
    \framedtopframe
    \framedbottomframe
    \framedframe
    \node [anchor=north west, inner sep=0pt, outer sep=0pt] at (0,0) {%
      \boxit[wd=\framedwd, ht=\framedht,
             lftoffset=\framedlftoffset, rgtoffset=\framedrgtoffset,
             topoffset=\framedtopoffset, botoffset=\framedbotoffset,
             before=\framedbefore, after=\framedafter,
             above=\framedabove,   below=\framedbelow]{#2}};
  \endtikzpicture}%
  %% —————————————————————————————————————————————————— %%
  \boxit[wd=\framedwd+\framedlftmargin+\framedrgtmargin,
         ht=\framedht+\framedtopmargin+\framedbotmargin,
         lftoffset=\framedlftmargin, rgtoffset=\framedrgtmargin,
         topoffset=\framedtopmargin, botoffset=\framedbotmargin,
         before=, after=, above=, below=]{\unhbox\framedbox}%
\endgroup}

\newsavebox\framedtextbox
\newtoks\framedtexttoks
\newenvironment{framedtext}[1][]{%
  \begingroup
  \pgfkeysfiltered{framed, width=\hsize,
    minimum width=-\maxdimen+10pt, maximum width=\hsize,
    height=-1pt, minimum height=-\maxdimen+10pt,
    margin=0pt, offset=3pt, before=, after=, above=, below=,
    frame=on, background=none, options={draw=fg,fill=bg,rounded corners}}%
  \pgfkeysfiltered{framed, #1}%
  \ifdim\framedwd<\framedminwd \framedwd=\framedminwd\fi
  \ifdim\framedwd>\framedmaxwd \framedwd=\framedmaxwd\fi
  \def\framedtextoptions{#1}%
  \begin{lrbox}\framedtextbox\vbox\bgroup\ignorespaces%
    \hsize=\dimexpr\framedwd-\framedlftoffset-\framedrgtoffset\relax
    \textwidth=\hsize \linewidth=\hsize \framedbefore\ignorespaces
}{%
  \framedafter\egroup\end{lrbox}\par
  \expandafter\framed\expandafter[\framedtextoptions]{\usebox\framedtextbox}%
  \endgroup}

%>>
%<< -- inframe >>

\newbox\inframebox
\newlength\inframelftoffset
\newlength\inframergtoffset
\newlength\inframetopoffset
\newlength\inframebotoffset

\pgfkeys{/inframe/.is family}

\pgfkeys{/inframe,
  lftoffset/.store as dimen=\inframelftoffset,
  rgtoffset/.store as dimen=\inframergtoffset,
  topoffset/.store as dimen=\inframetopoffset,
  botoffset/.store as dimen=\inframebotoffset,
  offset/.style={lftoffset=#1, rgtoffset=#1,
                 topoffset=#1, botoffset=#1},
  %% —————————————————————————————————————————————————— %%
  color/.store in=\inframecolor,
  text/.store in=\inframetext}

\def\inframe{\dosingleempty\doinframe}
\def\doinframe[#1]#2{%
  \setupinframe{offset=2pt, color=fg, text=fg, #1}%
  \setbox\inframebox=\hbox{#2}%
  \raisebox{-\dp\inframebox}{\color{\inframecolor}%
    \ruleit[wd=\wd\inframebox+\inframelftoffset+\inframergtoffset,
            lftoffset=\inframelftoffset, rgtoffset=\inframergtoffset,
            topoffset=\inframetopoffset, botoffset=\inframebotoffset]{{\color{\inframetext} #2}}}}

\definesetup{inframe}

%>>

\def\maketitle{%
  \begin{frame}[c,plain]\titlepage\end{frame}
  \usebeamer{normal text}}

\newlength\templen
\newlength\templena
\newlength\templenb

\renewenvironment{center}{\par\centering}{\par}

\def\cap#1{\bgroup\small \uppercase{#1}\egroup}
\def\slide#1 of #2{{\small(#1/#2)}}

\setbeamersize{text margin left=1.5em, text margin right=1.5em}

%>>

%<< Title page >>

\pgfkeys{/titlepage/.is family}

\pgfkeys{/titlepage,
  logo/.is choice,
  logo/empty/.code=\def\titlegraphic{},
  logo/institute/.code=\def\titlegraphic{%
    \vbox{\usebeamer{institute}\insertinstitute}},
  logo/custom/.code=\let\titlegraphic\logocustom@}

\definesetup{titlepage}

\def\logocustom#1{\def\logocustom@{#1}}\logocustom{}

%>>
%<< Headline >>

%<< -- setups >>

\pgfkeys{/headline/.is family}

\pgfkeys{/headline,
  left/.is choice,
  left/empty/.code=\let\acme@headline@left\@empty,
  left/page number/.code=\let\acme@headline@left\acme@pagenumber,
  left/custom/.code=\let\acme@headline@left\acme@headline@left@custom,
  left/predefined/.code=\acme@headline@predefined{left}{#1},
  left/.unknown/.code={%
    \let\acme@headline@left@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@headline@left@predefined@key}},
  %%
  left/section/.is choice, left/section/.default=text,
  left/section/text/.style={/headline/left/predefined=section},
  left/subsection/.is choice, left/subsection/.default=text,
  left/subsection/text/.style={/headline/left/predefined=subsection},
  left/subsection/bullets/.code=\let\acme@headline@left\acme@headline@subsection@bullets,
  left/subsection/squares/.code=\let\acme@headline@left\acme@headline@subsection@squares,
  %% —————————————————————————————————————————————————— %%
  center/.is choice,
  center/empty/.code=\let\acme@headline@center\@empty,
  center/page number/.code=\let\acme@headline@center\acme@pagenumber,
  center/custom/.code=\let\acme@headline@center\acme@headline@center@custom,
  center/predefined/.code=\acme@headline@predefined{center}{#1},
  center/.unknown/.code={%
    \let\acme@headline@center@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@headline@center@predefined@key}},
  %%
  center/section/.is choice, center/section/.default=text,
  center/section/text/.style={/headline/center/predefined=section},
  center/subsection/.is choice, center/subsection/.default=text,
  center/subsection/text/.style={/headline/center/predefined=subsection},
  center/subsection/bullets/.code=\let\acme@headline@center\acme@headline@subsection@bullets,
  center/subsection/squares/.code=\let\acme@headline@center\acme@headline@subsection@squares,
  %% —————————————————————————————————————————————————— %%
  right/.is choice,
  right/empty/.code=\let\acme@headline@right\@empty,
  right/page number/.code=\let\acme@headline@right\acme@pagenumber,
  right/custom/.code=\let\acme@headline@right\acme@headline@right@custom,
  right/predefined/.code=\acme@headline@predefined{right}{#1},
  right/.unknown/.code={%
    \let\acme@headline@right@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@headline@right@predefined@key}},
  %%
  right/section/.is choice, right/section/.default=text,
  right/section/text/.style={/headline/right/predefined=section},
  right/subsection/.is choice, right/subsection/.default=text,
  right/subsection/text/.style={/headline/right/predefined=subsection},
  right/subsection/bullets/.code=\let\acme@headline@right\acme@headline@subsection@bullets,
  right/subsection/squares/.code=\let\acme@headline@right\acme@headline@subsection@squares}

\definesetup{headline}

\let\acme@headline@left\@empty
\let\acme@headline@center\@empty
\let\acme@headline@right\@empty

\def\headlineleft#1{\def\acme@headline@left@custom{#1}}\headlineleft{}
\def\headlinecenter#1{\def\acme@headline@center@custom{#1}}\headlinecenter{}
\def\headlineright#1{\def\acme@headline@right@custom{#1}}\headlineright{}

%>>
%<< ---- sections >>
\let\acme@headline@section\@empty
%>>
%<< ---- subsections >>
\def\acme@headline@subsection@bullets{\@acme@headline@navigation}
\def\acme@headline@subsection@squares{%
  \setbeamertemplate{mini frame}{%
    \begin{pgfpicture}{0pt}{0pt}{0.1cm}{0.1cm}
      \pgfpathrectangle{\pgfpoint{0.0cm}{0.0cm}}{\pgfpoint{0.1cm}{0.1cm}}
      \pgfusepath{fill,stroke}
    \end{pgfpicture}}%
  \setbeamertemplate{mini frame in current subsection}{%
    \begin{pgfpicture}{0pt}{0pt}{0.1cm}{0.1cm}
      \pgfpathrectangle{\pgfpoint{0.0cm}{0.0cm}}{\pgfpoint{0.1cm}{0.1cm}}
      \pgfusepath{stroke}
    \end{pgfpicture}}\@acme@headline@navigation}

\let\acme@headline@subsection\@empty
%>>
%<< ---- predefined >>
\def\acme@headline@predefined#1#2{%
  \expandafter\def\csname acme@headline@#1\endcsname{\usebeamertemplate{#2 in head/foot}}}
%>>
%<< -- UGLY HACK, BEWARE! IT DOESN'T WORK QUITE RIGHT FOR NOW >>
\def\@acme@headline@navigation{%
  \def\sectionentry##1##2##3##4##5{}% section number, section title, page
  \def\slideentry##1##2##3##4##5##6{%
    % section number, subsection number, slide number, first/last frame, page number, part number
    \ifnum##6=\c@part\ifnum##2>0\ifnum##3>0%
    \ifnum\c@section=##1\beamer@xpos=##2\relax%
    \else\beamer@xpos=0\relax\fi%
    \beamer@ypos=0\relax%
    \hbox to 0pt{%
      \beamer@tempdim=-\beamer@vboxoffset%
      \advance\beamer@tempdim by-\beamer@boxsize%
      \multiply\beamer@tempdim by\beamer@ypos%
      % \advance\beamer@tempdim by -.05cm%ACME FIX
      \raise\beamer@tempdim\hbox{%
        \beamer@tempdim=\beamer@boxsize%
        \multiply\beamer@tempdim by\beamer@xpos%
        \advance\beamer@tempdim by -\beamer@boxsize%
        \advance\beamer@tempdim by 1pt%
        \kern\beamer@tempdim\hbox{\beamer@link(##4){%
            \usebeamerfont{mini frame}%
            \ifnum\c@section=##1%
              \ifnum\c@subsection=##2%
                \usebeamercolor[fg]{mini frame}%
                \usebeamertemplate{mini frame}%
              \else%
                \usebeamercolor{mini frame}%
                \usebeamertemplate{mini frame in other subsection}%
              \fi%
            \fi%
          }}}%\hskip-10cm plus 1fil%
    }\fi\fi%
    \else%
    \fakeslideentry{##1}{##2}{##3}{##4}{##5}{##6}%
    \fi\ignorespaces}
  \def\fakeslideentry##1##2##3##4##5##6{%
    \ifnum##2>0\ifnum##3>0%
    \ifbeamer@compress%
    \advance\beamer@xpos by1\relax%
    \else%
    \beamer@xpos=##3\relax%
    \beamer@ypos=##2\relax%
    \fi%
    \hbox to 0pt{\beamer@tempdim=-\beamer@vboxoffset%
      \advance\beamer@tempdim by -\beamer@boxsize%
      \multiply\beamer@tempdim by\beamer@ypos%
      \advance\beamer@tempdim by -.05cm%
      \raise\beamer@tempdim\hbox{}}\fi\fi\ignorespaces}
  \hbox{%
    \setbox\beamer@sectionbox=\hbox{}%
    \hskip-1.875ex plus-1fill\dohead%
    \box\beamer@sectionbox\hfil\hskip.3cm}%
}

%>>

\defbeamertemplate{headline}{acme}[2][]{
  \setupframed{margin=0pt, #1}%
  \setupheadline{#2}%
  \let\next\@empty
  \ifnum\insertframenumber=1 \else
    \templena=\paperwidth
    \advance\templena by -\framedlftmargin%
    \advance\templena by -\framedrgtmargin%
    \def\next{%
      \vskip\framedtopmargin%
      \vbox\bgroup\strut
      \hskip\framedlftmargin%
      \hbox to \templena\bgroup
        \hbox to \templena{\acme@headline@left\hss}\hskip-\templena
        \hbox to \templena{\hss\acme@headline@center\hss}\hskip-\templena
        \hbox to \templena{\hss\acme@headline@right}
      \egroup\egroup
      \vskip\framedbotmargin}
    \ifx\acme@headline@left\@empty
    \ifx\acme@headline@center\@empty
    \ifx\acme@headline@right\@empty
      \let\next\@empty\fi\fi\fi% nothing to show, then reclaim space
  \fi\next}

%>>
%<< Footline >>

%<< -- setups >>

\pgfkeys{/footline/.is family}

\pgfkeys{/footline,
  left/.is choice,
  left/empty/.code=\let\acme@footline@left\@empty,
  left/page number/.code=\let\acme@footline@left\acme@pagenumber,
  left/custom/.code=\let\acme@footline@left\acme@footline@left@custom,
  left/predefined/.code=\acme@footline@predefined{left}{#1},
  left/.unknown/.code={%
    \let\acme@footline@left@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@footline@left@predefined@key}},
  %%
  left/section/.is choice, left/section/.default=text,
  left/section/text/.style={/footline/left/predefined=section},
  left/subsection/.is choice, left/subsection/.default=text,
  left/subsection/text/.style={/footline/left/predefined=subsection},
  left/subsection/bullets/.code=\let\acme@footline@left\acme@footline@subsection@bullets,
  left/subsection/squares/.code=\let\acme@footline@left\acme@footline@subsection@squares,
  %% —————————————————————————————————————————————————— %%
  center/.is choice,
  center/empty/.code=\let\acme@footline@center\@empty,
  center/page number/.code=\let\acme@footline@center\acme@pagenumber,
  center/custom/.code=\let\acme@footline@center\acme@footline@center@custom,
  center/predefined/.code=\acme@footline@predefined{center}{#1},
  center/.unknown/.code={%
    \let\acme@footline@center@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@footline@center@predefined@key}},
  %%
  center/section/.is choice, center/section/.default=text,
  center/section/text/.style={/footline/center/predefined=section},
  center/subsection/.is choice, center/subsection/.default=text,
  center/subsection/text/.style={/footline/center/predefined=subsection},
  center/subsection/bullets/.code=\let\acme@footline@center\acme@footline@subsection@bullets,
  center/subsection/squares/.code=\let\acme@footline@center\acme@footline@subsection@squares,
  %% —————————————————————————————————————————————————— %%
  right/.is choice,
  right/empty/.code=\let\acme@footline@right\@empty,
  right/page number/.code=\let\acme@footline@right\acme@pagenumber,
  right/custom/.code=\let\acme@footline@right\acme@footline@right@custom,
  right/predefined/.code=\acme@footline@predefined{right}{#1},
  right/.unknown/.code={%
    \let\acme@footline@right@predefined@key\pgfkeyscurrentname%
    \pgfkeysalso{\pgfkeyscurrentpath/predefined=\acme@footline@right@predefined@key}},
  %%
  right/section/.is choice, right/section/.default=text,
  right/section/text/.style={/footline/right/predefined=section},
  right/subsection/.is choice, right/subsection/.default=text,
  right/subsection/text/.style={/footline/right/predefined=subsection},
  right/subsection/bullets/.code=\let\acme@footline@right\acme@footline@subsection@bullets,
  right/subsection/squares/.code=\let\acme@footline@right\acme@footline@subsection@squares}

\definesetup{footline}

\let\acme@footline@left\@empty
\let\acme@footline@center\@empty
\let\acme@footline@right\@empty

\def\footlineleft#1{\def\acme@footline@left@custom{#1}}\footlineleft{}
\def\footlinecenter#1{\def\acme@footline@center@custom{#1}}\footlinecenter{}
\def\footlineright#1{\def\acme@footline@right@custom{#1}}\footlineright{}

%>>
%<< ---- predefined >>

\def\acme@footline@predefined#1#2{%
  \expandafter\def\csname acme@footline@#1\endcsname{\usebeamertemplate{#2 in head/foot}}}

%>>

\defbeamertemplate{footline}{acme}[2][]{%
  \setupframed{margin=0pt, #1}%
  \setupfootline{#2}%
  \let\next\@empty
  \ifnum\insertframenumber=1 \else
    \templena=\paperwidth
    \advance\templena by -\framedlftmargin%
    \advance\templena by -\framedrgtmargin%
    \def\next{%
      \vskip\framedtopmargin%
      \vbox\bgroup\strut
      \hskip\framedlftmargin%
      \hbox to \templena\bgroup
        \hbox to \templena{\acme@footline@left\hss}\hskip-\templena
        \hbox to \templena{\hss\acme@footline@center\hss}\hskip-\templena
        \hbox to \templena{\hss\acme@footline@right}
      \egroup\egroup
      \vskip\framedbotmargin}
    \ifx\acme@footline@left\@empty
    \ifx\acme@footline@center\@empty
    \ifx\acme@footline@right\@empty
      \let\next\@empty\fi\fi\fi% nothing to show, then reclaim space
  \fi\next}

%>>
%<< Frametitle >>

\definesetup{frametitle}

\defbeamertemplate{frametitle}{acme}[2][]{%
  \framed[#1]{#2}}

%>>
%<< Page number >>

%<< -- setups >>

\pgfkeys{/pagenumber/.is family}

\pgfkeys{/pagenumber,
  .is choice, .value required,
  none/.code=\let\acme@pagenumber\@empty,
  boxed/.code=\let\acme@pagenumber\acme@pagenumber@boxed,
  plain/.code=\let\acme@pagenumber\acme@pagenumber@plain,
  custom/.code=\let\acme@pagenumber\acme@pagenumber@custom}

\definesetup{pagenumber}

\let\acme@pagenumber\@empty

\def\pagenumbercustom#1{\def\acme@pagenumber@custom{#1}}
\pagenumbercustom{}

%>>
%<< ---- styles: boxed or plain>>

\def\acme@pagenumber@boxed{\bgroup%
  \usebeamerfont{page number in head/foot}%
  \setbox0=\hbox{\strut00/00}\templena=\wd0\templenb=\ht0
  \multiply\templena by 15\divide\templena by 10%
  \multiply\templenb by 2%
  \usebeamercolor{page number in head/foot}%
  \hbox\bgroup\begin{tikzpicture}%
    \node [rectangle, draw=fg, fill=bg, rounded corners=1pt, minimum width=\templena,
           inner sep=0pt, outer sep=0pt, minimum height=\templenb,
           text=fg, text depth=1pt]%
    {\setbox0=\hbox{\strut00}\templena=\wd0%
      \usebeamerfont{page number in head/foot}\usebeamercolor[fg]{page number in head/foot}%
      \strut\hyperlinkpresentationstart{\hbox to\templena{\hfill\insertframenumber}}/%
      \hyperlinkpresentationend{\hbox to\templena{\inserttotalframenumber\hfill}}};
  \end{tikzpicture}\egroup\egroup}

\def\acme@pagenumber@plain{\bgroup%
  \usebeamerfont{page number in head/foot}\usebeamercolor[fg]{page number in head/foot}%
  \strut\hyperlinkpresentationstart{\insertframenumber}/%
  \hyperlinkpresentationend{\inserttotalframenumber}\egroup}

%>>

%>>

%<< Blocks >>

\newlength\blockswd

\pgfkeys{/blocks/.is family}

\pgfkeys{/blocks,
  .is choice, .default=.cd,
  plain/.code=\let\dododefineblock\defineblockplain,
  with full bar/.code=\let\dododefineblock\defineblockwithfullbar,
  with backgrounded bar/.code=\let\dododefineblock\defineblockwithbackgroundedbar,
  with bar/.code=\let\dododefineblock\defineblockwithbar,
  %%
  options/.store in=\blocksoptions,
  %%
  width/.store as dimen=\blockswd,
  boxalign/.is choice, halign/.value required,
  boxalign/none/.code=\let\blocksleft\@empty\let\blocksright\@empty,
  boxalign/left/.code=\let\blocksleft\@empty\let\blocksright\hfill,
  boxalign/center/.code=\let\blocksleft\hfill\let\blocksright\hfill,
  boxalign/right/.code=\let\blocksleft\hfill\let\blocksright\@empty}

\let\blocksleft\@empty\let\blocksright\@empty
\def\centerblock#1#2{}

\def\centerblock#1#2{%
  \expandafter\let\csname old\string#1\endcsname=#1%
  \expandafter\let\csname old\string#2\endcsname=#2%
  \renewcommand#1[1][]{%
    \pgfkeys{/blocks, ##1}%
    \begingroup\templena=\hsize\hsize=\blockswd%
    \hbox to \templena\bgroup\blocksleft\csname
    old\string#1\endcsname}
  \renewcommand#2{%
    \csname old\string#2\endcsname\blocksright\egroup\endgroup\leavevmode}}

\definesetup{blocks}

\setupblocks{width=.8\hsize, boxalign=center}

\def\defineblock{\dosingleempty\dodefineblock} % or \newcommand\defineblock[1][]{...}
\def\dodefineblock[#1]{%
  \edef\@temp{\noexpand\dododefineblock % \dododefineblock is set by \setupblocks{...}
    {block \ifx#1\relax\relax\else#1\space\fi begin}
    {block \ifx#1\relax\relax\else#1\space\fi end}
    {block title\ifx#1\relax\relax\else\space#1\fi}
    {block body\ifx#1\relax\relax\else\space#1\fi}}%
  \@temp}

\def\defineblocks{
  \defineblock%
  \defineblock[alerted]%
  \defineblock[example]%
  \centerblock\block\endblock
  \centerblock\alertblock\endalertblock
  \centerblock\exampleblock\endexampleblock}

%% block with a line below the the title that fully stretches on both sides
\def\defineblockwithfullbar#1#2#3#4{%
  \setbeamertemplate{#1}{\begingroup%
    \setbeamertemplate{itemize/enumerate body begin}{\vspace*{-5pt}}%
    \setbeamertemplate{itemize/enumerate body end}{\vspace*{-5pt}}%
    \mode<presentation>{%\usebeamerfont{block}%
      \setbeamercolor{local structure}{parent=#3}}%
    \usebeamercolor{#3}%
    \setupblocks{options={draw=fg!30, fill=bg, thick}}%
    \begin{lrbox}\framedtextbox\vbox\bgroup
      \hsize=\dimexpr\hsize-\framedlftoffset-\framedrgtoffset\relax
      \textwidth=\hsize \linewidth=\hsize\usebeamer{#4}}
  \setbeamertemplate{#2}{\egroup\end{lrbox}%
    \ifx\insertblocktitle\@empty
      \framed[width=\hsize, options=\blocksoptions]
      {\usebox\framedtextbox}
    \else
      \framed[width=\hsize, frame=off, offset=0pt]{%
        % title
        \framed[width=\hsize, options=\blocksoptions, customframe={\path [draw,fill]
          {[sharp corners] (0,0) -- ++(0,-\framedht) -- ++(\framedwd,0)}
          {[rounded corners=2pt] -- ++(0,\framedht) -- cycle};}]
        {\usebeamer{#3}\strut\insertblocktitle\vskip-2pt}
        \endgraf\vskip-.6pt
        % body
        \framed[width=\hsize, options=\blocksoptions, customframe={\path [draw]
          {[rounded corners=2pt] (0,0) -- ++(0,-\framedht) -- ++(\framedwd,0)}
          {[sharp corners] -- ++(0,\framedht)};}]
        {\usebox\framedtextbox}}
    \fi\endgroup}}

%% block with a line below the the title that fully stretches on both sides
\def\defineblockwithbackgroundedbar#1#2#3#4{%
  \setbeamertemplate{#1}{\begingroup%
    \setbeamertemplate{itemize/enumerate body begin}%
      {\kern-\dimexpr\topsep+\partopsep\relax\kern1ex\relax}%
    \setbeamertemplate{itemize/enumerate body end}%
      {\kern-\dimexpr\topsep+\partopsep\relax}%
    \setbeamercolor{local structure}{parent=#3, fg=#3.bg}%
    \usebeamercolor{#3}%
    \setupblocks{options={rounded corners=2pt, draw=bg, fill=bg, thick}}%
    \begin{lrbox}\framedtextbox\vbox\bgroup
      \hsize=\dimexpr\hsize-\framedlftoffset-\framedrgtoffset\relax
      \textwidth=\hsize \linewidth=\hsize\usebeamer{#4}}
  \setbeamertemplate{#2}{\egroup\end{lrbox}%
    \ifx\insertblocktitle\@empty
      \framed[width=\hsize, options=\blocksoptions]
      {\usebox\framedtextbox}
    \else
      \framed[width=\hsize, frame=off, offset=0pt]{%
        % title
        \framed[width=\hsize, options=\blocksoptions, customframe={\path [draw,fill]
          {[sharp corners] (0,0) -- ++(0,-\framedht) -- ++(\framedwd,0)}
          {[rounded corners=2pt] -- ++(0,\framedht) -- cycle};}]
        {\usebeamer{#3}\strut\insertblocktitle\vskip-2pt}
        \endgraf\vskip-.6pt
        % body
        \framed[width=\hsize, options=\blocksoptions, customframe={\path [draw]
          {[rounded corners=2pt] (0,0) -- ++(0,-\framedht) -- ++(\framedwd,0)}
          {[sharp corners] -- ++(0,\framedht)};}]
        {\usebox\framedtextbox}}
    \fi\endgroup}}

%% block with a line below the the title that partially stretches on both sides
\def\defineblockwithbar#1#2#3#4{%
  \setbeamertemplate{#1}{\begingroup%
    \setbeamertemplate{itemize/enumerate body begin}{\vspace*{-5pt}}%
    \setbeamertemplate{itemize/enumerate body end}{\vspace*{-5pt}}%
    \mode<presentation>{%
      \setbeamercolor{local structure}{parent=#3}}%
    \usebeamercolor{#3}%
    \setupblocks{options={draw=fg!30, fill=bg, thick, rounded corners=2pt}}%
    \begin{lrbox}\framedtextbox\vbox\bgroup
      \hsize=\dimexpr\hsize-\framedlftoffset-\framedrgtoffset\relax
      \textwidth=\hsize \linewidth=\hsize\usebeamer{#4}}
    \setbeamertemplate{#2}{\egroup\end{lrbox}%
      \ifx\insertblocktitle\@empty
        \framed[width=\hsize, options=\blocksoptions]
        {\usebox\framedtextbox}
      \else
        \begin{framedtext}
          [toffset=4pt, options=\blocksoptions, width=\hsize]%
          % title
          \framed[frame=off, bframe=on, options=\blocksoptions,
                  width=\hsize, offset=0pt, boffset=3pt]
          {\usebeamer{#3}\strut\insertblocktitle\vskip-2pt}
          \endgraf\vskip-.6pt
          % body
          \framed[width=\hsize, frame=off, offset=0pt, toffset=3pt]
          {\usebox\framedtextbox}
        \end{framedtext}
      \fi\endgroup}}

\def\defineblockplain#1#2#3#4{%
  \setbeamertemplate{#1}{%
    \setbeamertemplate{itemize/enumerate body begin}%
      {\kern-\dimexpr\topsep+\partopsep\relax\kern1ex\relax}%
    \setbeamertemplate{itemize/enumerate body end}%
      {\kern-\dimexpr\topsep+\partopsep\relax}%
    \setbeamercolor{local structure}{parent=#3}%
    \usebeamercolor{#3}%
    \setupblocks{options={draw=fg!30, fill=bg, rounded corners=2pt, thick}}%
    \begin{lrbox}\framedtextbox\vbox\bgroup
      \hsize=\dimexpr\hsize-\framedlftoffset-\framedrgtoffset\relax
      \textwidth=\hsize \linewidth=\hsize\usebeamer{#4}}
  \setbeamertemplate{#2}{\egroup\end{lrbox}%
    \framed[toffset=4pt, width=\hsize, options=\blocksoptions]{%
      \ifx\insertblocktitle\@empty\else
        {\usebeamer{#3}\strut\insertblocktitle\endgraf}\fi
      \usebox\framedtextbox}}}

%>>
%<< Items >>

%<< -- use pifont font for enumerations >>

\newcount\acme@enumerate@start
\def\enumeratestart#1{\acme@enumerate@start=#1}
\enumeratestart{192}

\newcount\acme@enumerate@item
\defbeamertemplate*{enumerate mini template}{acme}{%
  \ding{\acme@enumerate@item}%
  \global\advance\acme@enumerate@item by 1}

\let\oldenumerate=\enumerate
\def\acme@enumerate[#1]{%
  \oldenumerate[1]%
  \acme@enumerate@item=#1
  \advance\acme@enumerate@item by \acme@enumerate@start
  \advance\acme@enumerate@item by -1}
% \def\enumerate{%
%   \@ifnextchar[{\acme@enumerate}{\acme@enumerate[1]}}
% \let\enumerate\oldenumerate

%>>
%<< -- draw/fill bullet lists: bullets, squares, triangles %>>

%   or something completely different >>

\pgfkeys{/items/.is family,
  /items/.cd,
  /items/xshift/.initial=0pt,
  /items/yshift/.initial=0pt,
  /items/.unkown/.style={#1}}

\def\acmesquare{\dosingleempty\acme@square}
\def\acme@square[#1]{%
  \begin{tikzpicture}[baseline,xshift=\pgfkeysvalueof{/items/xshift},
                      yshift=\pgfkeysvalueof{/items/yshift}]
    \path [x=1pt,y=1pt,#1] (0,0) -- (0,1) -- (1,1) -- (1,0) -- cycle;
  \end{tikzpicture}}

\def\acmetriangle{\dosingleempty\acme@triangle}
\def\acme@triangle[#1]{%
  \begin{tikzpicture}[baseline,xshift=\pgfkeysvalueof{/items/xshift},
        yshift=\pgfkeysvalueof{/items/yshift}]
    \path [x=1pt,y=1pt,#1] (0,0) -- (0,1) -- (1,.5) -- cycle;
  \end{tikzpicture}}

\setlength\leftmargini{1em}
\setlength\leftmarginii{1em}
\setlength\leftmarginiii{1em}

\newif\ifacme@itemizes@strut@
\def\setitemizesstrutyes{\acme@itemizes@strut@true}
\def\setitemizesstrutno{\acme@itemizes@strut@false}
\def\resetitemizesstrut{\setitemizesstrutno}
\resetitemizesstrut

\def\acme@itemize@define#1#2[#3]{%
  {\usebeamerfont{#2}\usebeamercolor{#2}#1[#3]\ifacme@itemizes@strut@\strut\fi}}

\def\acme@items@default[#1]{%
  \setbeamertemplate{itemize item}{%
    \acme@itemize@define\acmesquare{itemize item}%
    [yshift=1.6,draw=fg,rounded corners=1.5,scale=4,#1]}
  \setbeamertemplate{itemize subitem}{%
    \acme@itemize@define\acmesquare{itemize subitem}%
    [yshift=1.5,draw,fill,color=fg,rounded corners=1.5,scale=3,#1]}
  \setbeamertemplate{itemize subsubitem}{%
    \acme@itemize@define\acmetriangle{itemize subsubitem}%
    [yshift=1,draw=fg,scale=3,#1]}}

\def\acme@items@squares[#1]{%
  \setbeamertemplate{itemize item}{%
    \acme@itemize@define\acmesquare{itemize item}%
    [yshift=1.6,draw=fg,fill=none,scale=4,#1]}%
  \setbeamertemplate{itemize subitem}{%
    \acme@itemize@define\acmesquare{itemize subitem}%
    [yshift=1.5,draw=fg,fill=none,scale=3,#1]}
  \setbeamertemplate{itemize subsubitem}{%
    \acme@itemize@define\acmesquare{itemize subsubitem}%
    [yshift=1,draw=fg,fill=none,scale=3,#1]}}

\def\acme@items@circles[#1]{%
  \setbeamertemplate{itemize item}{%
    \acme@itemize@define\acmesquare{itemize item}%
    [yshift=1.6,draw=fg,fill=none,rounded corners=2,scale=4,#1]}%
  \setbeamertemplate{itemize subitem}{%
    \acme@itemize@define\acmesquare{itemize subitem}%
    [yshift=1.5,draw=fg,fill=none,rounded corners=1.5,scale=3,#1]}
  \setbeamertemplate{itemize subsubitem}{%
    \acme@itemize@define\acmesquare{itemize subsubitem}%
    [yshift=1,draw=fg,fill=none,rounded corners=1.5,scale=3,#1]}}

\def\acme@items@triangles[#1]{%
  \setbeamertemplate{itemize item}{%
    \acme@itemize@define\acmetriangle{itemize item}%
    [yshift=1.6,draw=fg,fill=none,scale=4,#1]}%
  \setbeamertemplate{itemize subitem}{%
    \acme@itemize@define\acmetriangle{itemize subitem}%
    [yshift=1.5,draw=fg,fill=none,scale=3,#1]}
  \setbeamertemplate{itemize subsubitem}{%
    \acme@itemize@define\acmetriangle{itemize subsubitem}%
    [yshift=1,draw=fg,fill=none,scale=3,#1]}}

\def\acme@items@filledtriangles[#1]{%
  \setbeamertemplate{itemize item}{%
    \acme@itemize@define\acmetriangle{itemize item}%
    [yshift=1.6,draw=fg,fill=bg,scale=4,#1]}%
  \setbeamertemplate{itemize subitem}{%
    \acme@itemize@define\acmetriangle{itemize subitem}%
    [yshift=1.5,draw=fg,fill=bg,scale=3,#1]}
  \setbeamertemplate{itemize subsubitem}{%
    \acme@itemize@define\acmetriangle{itemize subsubitem}%
    [yshift=1,draw=fg,fill=bg,scale=3,#1]}}

\def\acme@items@filledsquares[#1]{%
  \setbeamertemplate{itemize item}{%
    \acme@itemize@define\acmesquare{itemize item}%
    [yshift=1.6,draw=fg,fill=bg,scale=4,#1]}%
  \setbeamertemplate{itemize subitem}{%
    \acme@itemize@define\acmesquare{itemize subitem}%
    [yshift=1.5,draw=fg,fill=bg,scale=3,#1]}
  \setbeamertemplate{itemize subsubitem}{%
    \acme@itemize@define\acmesquare{itemize subsubitem}%
    [yshift=1,draw=fg,fill=bg,scale=3,#1]}}

\def\acme@items@filledcircles[#1]{%
  \setbeamertemplate{itemize item}{%
    \acme@itemize@define\acmesquare{itemize item}%
    [yshift=1.6,draw=fg,fill=bg,rounded corners=2,scale=4,#1]}%
  \setbeamertemplate{itemize subitem}{%
    \acme@itemize@define\acmesquare{itemize subitem}%
    [yshift=1.5,draw=fg,fill=bg,rounded corners=1.5,scale=3,#1]}
  \setbeamertemplate{itemize subsubitem}{%
    \acme@itemize@define\acmesquare{itemize subsubitem}%
    [yshift=1,draw=fg,fill=bg,rounded corners=1.5,scale=3,#1]}}

\pgfkeys{/itemize items/.is family,
  /itemize items/.cd,
  .is choice,
  .value required,
  default/.code=\acme@items@default[#1],
  squares/.code=\acme@items@squares[#1],
  filled squares/.code=\acme@items@filledsquares[#1],
  circles/.code=\acme@items@circles[#1],
  filled circles/.code=\acme@items@filledcircles[#1],
  discs/.style={/itemize items/filled circles=#1},
  bullets/.style={/itemize items/filled circles=#1},
  triangles/.code=\acme@items@triangles[#1],
  filled triangles/.code=\acme@items@filledtriangles[#1]}

\def\setitemizeitems{\dosingleempty\@setitemizeitems}
\def\@setitemizeitems[#1]{\pgfkeys{/itemize items/.cd, #1}}
\let\resetitemizeitems\setitemizeitems

\resetitemizeitems

%>>

%>>
%<< Table of contents >>

\newlength\frametocheight
\newlength\frametochmargin
\newlength\frametocvmargin

\pgfkeys{/frametoc/.is family}

\pgfkeys{/frametoc,
  hmargin/.store as dimen=\frametochmargin,
  vmargin/.store as dimen=\frametocvmargin,
  margin/.style={hmargin=#1, vmargin=#1},
  height/.value required,
  height/.store as dimen=\frametocheight,
  .unknown/.code=} %ignore errors

\definesetup{frametoc}

\def\frametoc{\dosingleempty\doframetoc}
\def\doframetoc[#1]#2{%
  \setupframetoc{height=.5\paperheight, hmargin=10pt, vmargin=-5pt, #1}%
  \templen=\paperwidth%
  \advance\templen by -\Gm@lmargin%
  \advance\templen by -\Gm@rmargin%
  \advance\templen by -2\frametochmargin%
  \begin{frame}{#2}
    \hbox{%
      \usebeamercolor{frametoc}%
      \begin{tikzpicure}
        \node [draw=fg, fill=bg, rounded corners=3pt, thick, outer sep=0pt,
               inner xsep=\frametochmargin, inner ysep=\frametocvmargin,
               text width=\templen] {%
                 \vbox to \frametocheight{%
                   \vskip-1em plus 1fill\tableofcontents[#1]}};
      \end{tikzpicure}}
  \end{frame}}

%>>

%<< Emphasis >>

% BEWARE: VERY UGLY HACK BELOW
\def\emstyle{\def\@emstyle}
\emstyle{\usebeamerfont{emphasis}\usebeamercolor[fg]{emphasis}}
% \emstyle{\usebeamerfont{emphasis}\color{fg}}
\DeclareRobustCommand\em
{\@nomath\em \ifdim \fontdimen\@ne\font >\z@
  \color{normal text.fg}\mdseries \else\@emstyle \fi}
\let\beamer@orignewcomnoopt=\beamer@newcomnoopt
\let\beamer@orignewcomopt=\beamer@newcomopt
\long\def\beamer@newcomnoopt#1#2#3{%
  \ifnum#2=0\relax%
  \expandafter\def\expandafter#1\expandafter{\expandafter\beamer@sortzero\expandafter{\csname beamerx@\string#1\endcsname}}%
  \else
  \expandafter\def\expandafter#1\expandafter{\expandafter\beamer@sort\expandafter{\csname beamerx@\string#1\endcsname}{#2}}%
  \fi%
  \beamer@argscount=#2\relax%
  \advance\beamer@argscount by 1\relax%
  \expandafter\renewcommand\csname beamerx@\string#1\endcsname[\beamer@argscount]{#3}%
}
\long\def\beamer@newcomopt#1#2[#3]#4{%
  \expandafter\def\expandafter#1\expandafter{\expandafter\beamer@presort\expandafter{\csname beamerx@\string#1\endcsname}{#2}{#3}}%
  \beamer@argscount=#2\relax%
  \advance\beamer@argscount by 1\relax%
  \expandafter\renewcommand\csname beamerx@\string#1\endcsname[\beamer@argscount]{#4}%
}
\renewcommand<>{\emph}[1]{{\only#2{\em}#1}}

\let\beamer@newcomnoopt=\beamer@orignewcomnoopt
\let\beamer@newcomopt=\beamer@orignewcomopt

%>>
%<< Basic templates >>

%<< -- helpers >>

\def\acme@template@complex#1{\@ifnextchar[{\@acme@template@complex{#1}}{\@acme@template@complex{#1}[#1]}}
\def\@acme@template@complex#1[#2]#3#4#5#6{
  \defbeamertemplate*{#1}{acme}{%
    #5{\usebeamerfont{#1}\usebeamercolor[fg]{#1}#3\csname insert#2\endcsname#4}#6}}

\def\acme@template@simple#1{\@ifnextchar[{\@acme@template@simple{#1}}{\@acme@template@simple{#1}[#1]}}
\def\@acme@template@simple#1[#2]{\acme@template@complex{#1}[#2]{}{}{}{}}

%>>
% titlepage templates
\acme@template@simple{institute}
\acme@template@simple{title}
\acme@template@simple{subtitle}
\acme@template@simple{author}
\acme@template@simple{date}

% head/footline templates
\acme@template@simple{section in head/foot}[section]
\acme@template@simple{subsection in head/foot}[subsection]
\acme@template@simple{title in head/foot}[shorttitle]
\acme@template@simple{author in head/foot}[shortauthor]
\acme@template@simple{date in head/foot}[shortdate]

\setbeamertemplate{navigation symbols}{}
\defbeamertemplate*{navigation symbols in head/foot}{acme}{%
  {\usebeamerfont{navigation symbols in head/foot}
    \usebeamercolor[fg]{navigation symbols in head/foot}
    \insertslidenavigationsymbol \insertframenavigationsymbol
    \insertsubsectionnavigationsymbol \insertsectionnavigationsymbol
    \insertdocnavigationsymbol \insertbackfindforwardnavigationsymbol}}

% table of contents templates
\acme@template@complex{section in toc}[tocsection]%
  {}{}
  {\vskip3pt minus 3pt\leavevmode\usebeamertemplate{itemize item}\hskip\labelsep}{}
\acme@template@complex{subsection in toc}[tocsubsection]%
  {}{}
  {\vskip3pt minus 3pt\leavevmode\hskip\leftmarginii\usebeamertemplate{itemize subitem}\hskip\labelsep}{\endgraf}

%>>
%<< Colors >>

%<< helpers >>

\def\acme@define@fg@color#1{%
  \ifbeamercolorempty[fg]{#1}%
  {\definecolor{fg}{named}{#1}\color{#1}}%
  {\usebeamercolor[fg]{#1}}}

%>>
% color definitions
\definecolor{acme@nearlyblack}{RGB}{17,11,4}
\definecolor{acme@nearlywhite}{RGB}{253,252,254}
\definecolor{acme@darkorange}{RGB}{188,90,18}
\definecolor{acme@solidblue}{RGB}{9,51,106}
\definecolor{acme@softgray}{RGB}{105,105,105}
\definecolor{acme@darkyellow}{rgb}{.95,.95,.85}

% general definitions
\setbeamercolor{normal text}{fg=gray!30!black,bg=gray!3}
\setbeamercolor{structure}{fg=acme@solidblue!80!gray,bg=acme@solidblue!70!gray!5}

\setbeamercolor{alerted text}{use=normal text,fg=normal text.fg!40!red}% {fg=acmebeamer@darkorange!80!orange}
\setbeamercolor{example text}{fg=green!50!black}
\setbeamercolor{emphasis}{use=normal text,fg=acme@darkorange}

%>>
%<< Fonts >>

% general fonts
\setbeamerfont{normal text}{size=\large}
\setbeamerfont{emphasis}{shape=\itshape,series=\bfseries}

%>>

%<< DEFAULT theme >>

%<< -- colors >>

\def\default@colors{
  \setbeamercolor{background canvas}{parent=normal text}
  \setbeamercolor{background}{parent=background canvas}

  \setbeamercolor{palette primary}{use=structure,fg=structure.fg}
  \setbeamercolor{palette secondary}{use=structure,fg=structure.fg!75!black}
  \setbeamercolor{palette tertiary}{use=structure,fg=structure.fg!50!black}
  \setbeamercolor{palette quaternary}{fg=black!30}

  \setbeamercolor{palette sidebar primary}{use=normal text,fg=normal text.fg}
  \setbeamercolor{palette sidebar secondary}{use=structure,fg=structure.fg}
  \setbeamercolor{palette sidebar tertiary}{use=normal text,fg=normal text.fg}
  \setbeamercolor{palette sidebar quaternary}{use=structure,fg=structure.fg}

  \setbeamercolor{math text}{}
  \setbeamercolor{math text inlined}{parent=math text}
  \setbeamercolor{math text displayed}{parent=math text}

  \setbeamercolor{normal text in math text}{}

  \setbeamercolor{local structure}{parent=structure}

  \setbeamercolor{titlelike}{parent=structure}

  \setbeamercolor{title}{parent=titlelike}
  \setbeamercolor{title in head/foot}{parent=palette quaternary}
  \setbeamercolor{title in sidebar}{parent=palette sidebar quaternary}

  \setbeamercolor{subtitle}{parent=title}

  \setbeamercolor{author}{fg=gray!45!black}
  \setbeamercolor{author in head/foot}{parent=title in head/foot}
  \setbeamercolor{author in sidebar}{use=palette sidebar tertiary,fg=palette sidebar tertiary.fg}

  \setbeamercolor{institute}{fg=gray!25!black}
  \setbeamercolor{institute in head/foot}{parent=palette tertiary}
  \setbeamercolor{institute in sidebar}{use=palette sidebar tertiary,fg=palette sidebar tertiary.fg}

  \setbeamercolor{date}{parent=author}
  \setbeamercolor{date in head/foot}{parent=title in head/foot}
  \setbeamercolor{date in sidebar}{use=palette sidebar tertiary,fg=palette sidebar tertiary.fg}

  \setbeamercolor{titlegraphic}{}

  \setbeamercolor{part name}{}
  \setbeamercolor{part title}{parent=titlelike}

  \setbeamercolor{section name}{}
  \setbeamercolor{section title}{parent=titlelike}

  \setbeamercolor{section in toc}{parent=normal text,use=normal text,fg=normal text.fg!90}
  \setbeamercolor{section in toc shaded}{parent=section in toc}
  \setbeamercolor{section in head/foot}{parent=palette quaternary}
  \setbeamercolor{section in sidebar}{parent=palette sidebar secondary}
  \setbeamercolor{section in sidebar shaded}{use=section in sidebar,fg=section in sidebar.fg!40!bg}
  \setbeamercolor{section number projected}{parent=item projected}

  \setbeamercolor{subsection name}{}
  \setbeamercolor{subsection title}{parent=titlelike}

  \setbeamercolor{subsection in toc}{parent=section in toc}
  \setbeamercolor{subsection in toc shaded}{parent=subsection in toc}
  \setbeamercolor{subsection in head/foot}{parent=section in head/foot}
  \setbeamercolor{subsection in sidebar}{parent=palette sidebar primary}
  \setbeamercolor{subsection in sidebar shaded}{use=subsection in sidebar,fg=subsection in sidebar.fg!40!bg}
  \setbeamercolor{subsection number projected}{parent={subitem projected}}

  \setbeamercolor{subsubsection in toc}{parent=subsection in toc}
  \setbeamercolor{subsubsection in toc shaded}{parent=subsubsection in toc}
  \setbeamercolor{subsubsection in head/foot}{parent=subsection in head/foot}
  \setbeamercolor{subsubsection in sidebar}{parent=subsection in sidebar}
  \setbeamercolor{subsubsection in sidebar shaded}{parent=subsection in sidebar shaded}
  \setbeamercolor{subsubsection number projected}{parent=subsubitem projected}

  \setbeamercolor{headline}{}
  \setbeamercolor{footline}{}

  \setbeamercolor{sidebar}{}
  \setbeamercolor{sidebar left}{parent=sidebar}
  \setbeamercolor{sidebar right}{parent=sidebar}

  \setbeamercolor{logo}{parent=palette secondary}

  \setbeamercolor{frametitle}{parent=titlelike}
  \setbeamercolor{framesubtitle}{parent=frametitle}

  \setbeamercolor{frametitle right}{parent=frametitle}

  \setbeamercolor{caption}{}
  \setbeamercolor{caption name}{parent=structure}

  \setbeamercolor{button}{use=local structure,bg=local structure.fg!50!bg,fg=white}
  \setbeamercolor{button border}{use=button,fg=button.bg}
  \setbeamercolor{navigation symbols}{use=local structure,fg=local structure.fg!40!bg}
  \setbeamercolor{navigation symbols dimmed}{use=local structure,fg=local structure.fg!20!bg}
  \setbeamercolor{mini frame}{parent=section in head/foot}

  \setbeamercolor{block body}{parent=normal text}
  \setbeamercolor{block body alerted}{parent=normal text}
  \setbeamercolor{block body example}{parent=normal text}
  \setbeamercolor{block title}{parent=structure}
  \setbeamercolor{block title alerted}{parent=alerted text}
  \setbeamercolor{block title example}{parent=example text}

  \setbeamercolor{item}{parent=local structure}
  \setbeamercolor{subitem}{parent=item}
  \setbeamercolor{subsubitem}{parent=subitem}

  \setbeamercolor{item projected}{parent=item,use=item,fg=white,bg=item.fg}
  \setbeamercolor{subitem projected}{parent=item projected}
  \setbeamercolor{subsubitem projected}{parent=subitem projected}

  \setbeamercolor{enumerate item}{parent=item}
  \setbeamercolor{enumerate subitem}{parent=subitem}
  \setbeamercolor{enumerate subsubitem}{parent=subsubitem}

  \setbeamercolor{itemize item}{parent=item}
  \setbeamercolor{itemize subitem}{parent=subitem}
  \setbeamercolor{itemize subsubitem}{parent=subsubitem}

  \setbeamercolor{itemize/enumerate body}{}
  \setbeamercolor{itemize/enumerate subbody}{}
  \setbeamercolor{itemize/enumerate subsubbody}{}

  \setbeamercolor{description item}{parent=item}

  \setbeamercolor{bibliography item}{parent=item}

  \setbeamercolor{bibliography entry author}{use=structure,fg=structure.fg}
  \setbeamercolor{bibliography entry title}{use=normal text,fg=normal text.fg}
  \setbeamercolor{bibliography entry location}{use=structure,fg=structure.fg!65!bg}
  \setbeamercolor{bibliography entry note}{use=structure,fg=structure.fg!65!bg}

  \setbeamercolor{separation line}{}

  \setbeamercolor{upper separation line head}{parent=separation line}
  \setbeamercolor{middle separation line head}{parent=separation line}
  \setbeamercolor{lower separation line head}{parent=separation line}

  \setbeamercolor{upper separation line foot}{parent=separation line}
  \setbeamercolor{middle separation line foot}{parent=separation line}
  \setbeamercolor{lower separation line foot}{parent=separation line}

  \setbeamercolor{abstract}{}
  \setbeamercolor{abstract title}{parent=structure}

  \setbeamercolor{verse}{}

  \setbeamercolor{quotation}{}
  \setbeamercolor{quote}{parent=quotation}

  \setbeamercolor{page number in head/foot}{fg=black!50}

  \setbeamercolor{qed symbol}{parent=structure}

  % personnal additions
  \setbeamercolor{big box}{parent=structure}
  \setbeamercolor{title box}{parent=big box}
  \setbeamercolor{frametoc}{parent=structure,use=structure,fg=structure.fg!90}
}

%>>
%<< -- fonts >>

\def\default@fonts{
  \setbeamerfont{normal text}{} % ignored currently
  \setbeamerfont{alerted text}{}
  \setbeamerfont{example text}{}

  \setbeamerfont{structure}{series=\bfseries}
  \setbeamerfont{tiny structure}{size=\tiny}

  \setbeamerfont{title}{size=\Large,parent=structure}
  \setbeamerfont{title in head/foot}{shape=\itshape}
  \setbeamerfont{title in sidebar}{size=\tiny}

  \setbeamerfont{subtitle}{size=\normalsize,parent=title}

  \setbeamerfont{author}{size=\footnotesize}
  \setbeamerfont{author in head/foot}{}
  \setbeamerfont{author in sidebar}{size=\tiny}

  \setbeamerfont{institute}{size=\tiny}
  \setbeamerfont{institute in head/foot}{}
  \setbeamerfont{institute in sidebar}{}

  \setbeamerfont{date}{size=\scriptsize}
  \setbeamerfont{date in head/foot}{}
  \setbeamerfont{date in sidebar}{}

  \setbeamerfont{part name}{size=\LARGE}
  \setbeamerfont{part title}{size=\LARGE,parent=title}

  \setbeamerfont{section name}{size=\Large}
  \setbeamerfont{section title}{size=\Large,parent=title}

  \setbeamerfont{section in toc}{parent=structure}
  \setbeamerfont{section in toc shaded}{parent=section in toc}
  \setbeamerfont{section in head/foot}{}
  \setbeamerfont{section in sidebar}{size=\tiny}
  \setbeamerfont{section number projected}{size=\small,parent={section in toc,projected text}}

  \setbeamerfont{subsection name}{size=\large}
  \setbeamerfont{subsection title}{size=\large,parent=title}

  \setbeamerfont{subsection in toc}{size=\small}
  \setbeamerfont{subsection in toc shaded}{parent=subsection in toc}
  \setbeamerfont{subsection in head/foot}{}
  \setbeamerfont{subsection in sidebar}{}

  \setbeamerfont{subsubsection in toc}{size=\footnotesize}

  \setbeamerfont{subsubsection in toc shaded}{parent=subsubsection in toc}
  \setbeamerfont{subsubsection in head/foot}{}
  \setbeamerfont{subsubsection in sidebar}{}

  \setbeamerfont{headline}{parent={tiny structure}}
  \setbeamerfont{footline}{parent={tiny structure}}

  \setbeamerfont{sidebar}{size=\Tiny,parent={tiny structure}}
  \setbeamerfont{sidebar left}{parent=sidebar}
  \setbeamerfont{sidebar right}{parent=sidebar}

  \setbeamerfont{frametitle}{parent=structure,size=\Large,series=\bfseries,shape=\scshape}
  \setbeamerfont{framesubtitle}{parent=frametitle,size=\normalsize}

  \setbeamerfont{caption}{size=\small}
  \setbeamerfont{caption name}{parent={structure,caption}}

  \setbeamerfont{button}{size=\tiny}

  \setbeamerfont{block body}{}
  \setbeamerfont{block body alerted}{}
  \setbeamerfont{block body example}{}
  \setbeamerfont{block title}{size=\large,parent={structure,block body}}
  \setbeamerfont{block title alerted}{parent={block title,alerted text}}
  \setbeamerfont{block title example}{parent={block title,example text}}
  \setbeamerfont{block title example}{parent={block title,example text}}

  \setbeamerfont{item}{parent=structure}
  \setbeamerfont{subitem}{parent=item}
  \setbeamerfont{subsubitem}{parent=subitem}

  \setbeamerfont{item projected}{size=\tiny,parent={item,projected text}}
  \setbeamerfont{subitem projected}{parent=item projected}
  \setbeamerfont{subsubitem projected}{parent=subitem projected}

  \setbeamerfont{itemize item}{parent=item}
  \setbeamerfont{itemize subitem}{parent=subitem}
  \setbeamerfont{itemize subsubitem}{parent=subsubitem}

  \setbeamerfont{enumerate item}{parent=item}
  \setbeamerfont{enumerate subitem}{parent=subitem}
  \setbeamerfont{enumerate subsubitem}{parent=subsubitem}

  \setbeamerfont{itemize/enumerate body}{}
  \setbeamerfont{itemize/enumerate subbody}{size=\small}
  \setbeamerfont{itemize/enumerate subsubbody}{size=\footnotesize}

  \setbeamerfont{description item}{parent=item}

  \setbeamerfont{projected text}{parent={tiny structure}}

  \setbeamerfont{abstract}{size=\small}
  \setbeamerfont{abstract title}{parent={abstract,structure},size=\normalsize}

  \setbeamerfont{verse}{family=\rmfamily,shape=\itshape}

  \setbeamerfont{quotation}{shape=\itshape}
  \setbeamerfont{quote}{parent=quotation}

  \setbeamerfont{note page}{size=\small}

  % personnal additions
  \setbeamerfont{page number in head/foot}{size=\Tiny,shape=\upshape,series=\bfseries}%
}

%>>

\def\defaulttheme{%
  %% —— fonts and colors —————————————————————————————— %%
  \default@fonts
  \default@colors
  %% —— title page ———————————————————————————————————— %%
  \defbeamertemplate*{title page}{acme}[1][]{%
    \setuptitlepage{##1}%
    \templena=12pt%
    \templenb=5pt%
    \begin{tikzpicture}[remember picture, overlay]
      %% big box in the upper half
      {\usebeamercolor{structure}
      \filldraw [color=fg, rounded corners=1pt]%
        ([xshift=\templena, yshift=-\templena]current page.north west)%
        rectangle ++(\paperwidth-2\templena,-.5\textheight+\templena);}%
      %% title(/subtitle) below that box
      \node [anchor=north west, draw=structure.fg!40, fill=structure.bg, rounded corners=1pt,
             inner sep=\templenb, text width=\paperwidth-2\templena-2\templenb]%
        at ([xshift=\templena, yshift=-.5\textheight-\templena]current page.north west)%
        (title box)%
        {\vbox\bgroup%
          \hbox{\usebeamer{title}\strut\inserttitle}%
          \ifx\insertsubtitle\@empty\else%
            \hbox{\usebeamer{subtitle}\strut\insertsubtitle}\fi%
          \egroup};%
      %% author/date below the title/subtitle
      \node [anchor=north west, inner sep=0pt, text width=\paperwidth-2\templena]%
        at ([yshift=-\templena]title box.south west)%
        {{\usebeamer{author}\insertauthor}\hfill{\usebeamer{date}\insertdate}};%
      %% institute at the bottom
      \node [anchor=south, inner sep=0pt]%
        at ([yshift=\templena]current page.south)%
        {\centering\titlegraphic\endgraf};
    \end{tikzpicture}}%
  %%
  %% —— headline —————————————————————————————————————— %%
  \setbeamertemplate{headline}[acme]%
    [width=\hsize,lmargin=\Gm@lmargin+1pt, rmargin=\Gm@rmargin, tmargin=3pt, bmargin=0pt]%
    {left=section, right=empty}%
  %%
  %% —— footline —————————————————————————————————————— %%
  \setbeamertemplate{footline}[acme]%
    [width=\hsize,lmargin=\Gm@lmargin+1pt, rmargin=\Gm@rmargin, tmargin=0pt, bmargin=0pt]%
    {left=author, center=date, right=title}%
  %%
  %% —— frametitle ———————————————————————————————————— %%
  \setuppagenumber{boxed}%
  \setbeamertemplate{frametitle}[acme]%
    [width=\hsize,frame=off, tframe=on, offset=0pt, toffset=1pt,
            options={draw=structure.fg, very thick}]%
    {\vbox\bgroup
      \hbox to \hsize{\usebeamer{frametitle}\strut\insertframetitle\hfill\acme@pagenumber}\vskip-6pt%
      \hbox{\usebeamer{framesubtitle}\insertframesubtitle}\egroup}
  %%
  %% —— blocks ———————————————————————————————————————— %%
  \setupblocks{plain}%
  \defineblocks
  %%
  %% —— items ————————————————————————————————————————— %%
  \setitemizesstrutyes%
  \setlength\leftmarginiii{.8em}%
  \setbeamertemplate{itemize item}{%
      \acme@itemize@define\acmesquare{itemize item}%
      [yshift=1.6,draw=fg,fill=fg,rounded corners=1,scale=4]}
    \setbeamertemplate{itemize subsubitem}{%
      \acme@itemize@define\acmetriangle{itemize subsubitem}%
      [yshift=1.6,draw=fg,scale=2.6]}
  \let\enumerate\oldenumerate%
}

%>>
%<< PLAIN theme >>

%<< -- colors >>

\def\plain@colors{
  \setbeamercolor{background canvas}{parent=normal text}
  \setbeamercolor{background}{parent=background canvas}

  \setbeamercolor{palette primary}{use=structure,fg=structure.fg}
  \setbeamercolor{palette secondary}{use=structure,fg=structure.fg!75!black}
  \setbeamercolor{palette tertiary}{use=structure,fg=structure.fg!50!black}
  \setbeamercolor{palette quaternary}{fg=gray!65!black}

  \setbeamercolor{palette sidebar primary}{use=normal text,fg=normal text.fg}
  \setbeamercolor{palette sidebar secondary}{use=structure,fg=structure.fg}
  \setbeamercolor{palette sidebar tertiary}{use=normal text,fg=normal text.fg}
  \setbeamercolor{palette sidebar quaternary}{use=structure,fg=structure.fg}

  \setbeamercolor{math text}{}
  \setbeamercolor{math text inlined}{parent=math text}
  \setbeamercolor{math text displayed}{parent=math text}

  \setbeamercolor{normal text in math text}{}

  \setbeamercolor{local structure}{parent=palette quaternary}

  \setbeamercolor{titlelike}{parent=palette quaternary}

  \setbeamercolor{title}{parent=titlelike}
  \setbeamercolor{title in head/foot}{fg=black}
  \setbeamercolor{title in sidebar}{parent=palette sidebar quaternary}

  \setbeamercolor{subtitle}{parent=title}

  \setbeamercolor{author}{fg=gray!45!black}
  \setbeamercolor{author in head/foot}{parent=title in head/foot}
  \setbeamercolor{author in sidebar}{use=palette sidebar tertiary,fg=palette sidebar tertiary.fg}

  \setbeamercolor{institute}{fg=gray!25!black}
  \setbeamercolor{institute in head/foot}{parent=palette tertiary}
  \setbeamercolor{institute in sidebar}{use=palette sidebar tertiary,fg=palette sidebar tertiary.fg}

  \setbeamercolor{date}{parent=author}
  \setbeamercolor{date in head/foot}{parent=title in head/foot}
  \setbeamercolor{date in sidebar}{use=palette sidebar tertiary,fg=palette sidebar tertiary.fg}

  \setbeamercolor{titlegraphic}{}

  \setbeamercolor{part name}{}
  \setbeamercolor{part title}{parent=titlelike}

  \setbeamercolor{section name}{}
  \setbeamercolor{section title}{parent=titlelike}

  \setbeamercolor{section in toc}{parent=local structure}
  \setbeamercolor{section in toc shaded}{parent=section in toc}
  \setbeamercolor{section in head/foot}{parent=palette quaternary}
  \setbeamercolor{section in sidebar}{parent=palette sidebar secondary}
  \setbeamercolor{section in sidebar shaded}{use=section in sidebar,fg=section in sidebar.fg!40!bg}
  \setbeamercolor{section number projected}{parent=item projected}

  \setbeamercolor{subsection name}{}
  \setbeamercolor{subsection title}{parent=titlelike}

  \setbeamercolor{subsection in toc}{parent=section in toc}
  \setbeamercolor{subsection in toc shaded}{parent=subsection in toc}
  \setbeamercolor{subsection in head/foot}{parent=section in head/foot}
  \setbeamercolor{subsection in sidebar}{parent=palette sidebar primary}
  \setbeamercolor{subsection in sidebar shaded}{use=subsection in sidebar,fg=subsection in sidebar.fg!40!bg}
  \setbeamercolor{subsection number projected}{parent={subitem projected}}

  \setbeamercolor{subsubsection in toc}{parent=subsection in toc}
  \setbeamercolor{subsubsection in toc shaded}{parent=subsubsection in toc}
  \setbeamercolor{subsubsection in head/foot}{parent=subsection in head/foot}
  \setbeamercolor{subsubsection in sidebar}{parent=subsection in sidebar}
  \setbeamercolor{subsubsection in sidebar shaded}{parent=subsection in sidebar shaded}
  \setbeamercolor{subsubsection number projected}{parent=subsubitem projected}

  \setbeamercolor{headline}{}
  \setbeamercolor{footline}{}

  \setbeamercolor{sidebar}{}
  \setbeamercolor{sidebar left}{parent=sidebar}
  \setbeamercolor{sidebar right}{parent=sidebar}

  \setbeamercolor{logo}{parent=palette secondary}

  \setbeamercolor{frametitle}{parent=titlelike}
  \setbeamercolor{framesubtitle}{parent=frametitle}

  \setbeamercolor{frametitle right}{parent=frametitle}

  \setbeamercolor{caption}{}
  \setbeamercolor{caption name}{parent=structure}

  \setbeamercolor{button}{use=local structure,bg=local structure.fg!50!bg,fg=white}
  \setbeamercolor{button border}{use=button,fg=button.bg}
  \setbeamercolor{navigation symbols}{use=local structure,fg=local structure.fg!40!bg}
  \setbeamercolor{navigation symbols dimmed}{use=local structure,fg=local structure.fg!20!bg}
  \setbeamercolor{mini frame}{parent=section in head/foot}

  \setbeamercolor{block body}{parent=normal text}
  \setbeamercolor{block body alerted}{parent=normal text}
  \setbeamercolor{block body example}{parent=normal text}
  \setbeamercolor{block title}{parent=structure}
  \setbeamercolor{block title alerted}{parent=alerted text}
  \setbeamercolor{block title example}{parent=example text}

  \setbeamercolor{item}{parent=local structure}
  \setbeamercolor{subitem}{parent=item}
  \setbeamercolor{subsubitem}{parent=subitem}

  \setbeamercolor{item projected}{parent=item,use=item,fg=white,bg=item.fg}
  \setbeamercolor{subitem projected}{parent=item projected}
  \setbeamercolor{subsubitem projected}{parent=subitem projected}

  \setbeamercolor{enumerate item}{parent=item}
  \setbeamercolor{enumerate subitem}{parent=subitem}
  \setbeamercolor{enumerate subsubitem}{parent=subsubitem}

  \setbeamercolor{itemize item}{parent=item}
  \setbeamercolor{itemize subitem}{parent=subitem}
  \setbeamercolor{itemize subsubitem}{parent=subsubitem}

  \setbeamercolor{itemize/enumerate body}{}
  \setbeamercolor{itemize/enumerate subbody}{}
  \setbeamercolor{itemize/enumerate subsubbody}{}

  \setbeamercolor{description item}{parent=item}

  \setbeamercolor{bibliography item}{parent=item}

  \setbeamercolor{bibliography entry author}{use=structure,fg=structure.fg}
  \setbeamercolor{bibliography entry title}{use=normal text,fg=normal text.fg}
  \setbeamercolor{bibliography entry location}{use=structure,fg=structure.fg!65!bg}
  \setbeamercolor{bibliography entry note}{use=structure,fg=structure.fg!65!bg}

  \setbeamercolor{separation line}{}

  \setbeamercolor{upper separation line head}{parent=separation line}
  \setbeamercolor{middle separation line head}{parent=separation line}
  \setbeamercolor{lower separation line head}{parent=separation line}

  \setbeamercolor{upper separation line foot}{parent=separation line}
  \setbeamercolor{middle separation line foot}{parent=separation line}
  \setbeamercolor{lower separation line foot}{parent=separation line}

  \setbeamercolor{abstract}{}
  \setbeamercolor{abstract title}{parent=structure}

  \setbeamercolor{verse}{}

  \setbeamercolor{quotation}{}
  \setbeamercolor{quote}{parent=quotation}

  \setbeamercolor{page number in head/foot}{fg=black}

  \setbeamercolor{qed symbol}{parent=structure}

  % personnal additions
  \setbeamercolor{big box}{parent=structure}
  \setbeamercolor{title box}{parent=big box}
  \setbeamercolor{frametoc}{parent=local structure}
}

%>>
%<< -- fonts >>

\def\plain@fonts{
  \setbeamerfont{normal text}{} % ignored currently
  \setbeamerfont{alerted text}{}
  \setbeamerfont{example text}{}

  \setbeamerfont{structure}{series=\bfseries}
  \setbeamerfont{tiny structure}{size=\tiny}

  \setbeamerfont{title}{size=\large,shape=\scshape,series=\bfseries}
  \setbeamerfont{title in head/foot}{size=\Tiny,shape=\scshape}
  \setbeamerfont{title in sidebar}{size=\tiny}

  \setbeamerfont{subtitle}{parent=title,size=\footnotesize}

  \setbeamerfont{author}{size=\footnotesize}
  \setbeamerfont{author in head/foot}{}
  \setbeamerfont{author in sidebar}{size=\tiny}

  \setbeamerfont{institute}{size=\tiny}
  \setbeamerfont{institute in head/foot}{}
  \setbeamerfont{institute in sidebar}{}

  \setbeamerfont{date}{size=\tiny}
  \setbeamerfont{date in head/foot}{}
  \setbeamerfont{date in sidebar}{}

  \setbeamerfont{part name}{size=\LARGE}
  \setbeamerfont{part title}{size=\LARGE,parent=title}

  \setbeamerfont{section name}{size=\Large}
  \setbeamerfont{section title}{size=\Large,parent=title}

  \setbeamerfont{section in toc}{parent=structure}
  \setbeamerfont{section in toc shaded}{parent=section in toc}
  \setbeamerfont{section in head/foot}{}
  \setbeamerfont{section in sidebar}{size=\tiny}
  \setbeamerfont{section number projected}{size=\small,parent={section in toc,projected text}}

  \setbeamerfont{subsection name}{size=\large}
  \setbeamerfont{subsection title}{size=\large,parent=title}

  \setbeamerfont{subsection in toc}{size=\small}
  \setbeamerfont{subsection in toc shaded}{parent=subsection in toc}
  \setbeamerfont{subsection in head/foot}{}
  \setbeamerfont{subsection in sidebar}{}

  \setbeamerfont{subsubsection in toc}{size=\footnotesize}

  \setbeamerfont{subsubsection in toc shaded}{parent=subsubsection in toc}
  \setbeamerfont{subsubsection in head/foot}{}
  \setbeamerfont{subsubsection in sidebar}{}

  \setbeamerfont{headline}{parent={tiny structure}}
  \setbeamerfont{footline}{parent={tiny structure}}

  \setbeamerfont{sidebar}{size=\Tiny,parent={tiny structure}}
  \setbeamerfont{sidebar left}{parent=sidebar}
  \setbeamerfont{sidebar right}{parent=sidebar}

  \setbeamerfont{frametitle}{parent=structure,size=\Large,shape=\scshape,series=\bfseries}
  \setbeamerfont{framesubtitle}{parent=frametitle,size=\normalsize}

  \setbeamerfont{caption}{size=\small}
  \setbeamerfont{caption name}{parent={structure,caption}}

  \setbeamerfont{button}{size=\tiny}

  \setbeamerfont{block body}{}
  \setbeamerfont{block body alerted}{}
  \setbeamerfont{block body example}{}
  \setbeamerfont{block title}{size=\large,parent={structure,block body}}
  \setbeamerfont{block title alerted}{parent={block title,alerted text}}
  \setbeamerfont{block title example}{parent={block title,example text}}
  \setbeamerfont{block title example}{parent={block title,example text}}

  \setbeamerfont{item}{parent=structure}
  \setbeamerfont{subitem}{parent=item}
  \setbeamerfont{subsubitem}{parent=subitem}

  \setbeamerfont{item projected}{size=\tiny,parent={item,projected text}}
  \setbeamerfont{subitem projected}{parent=item projected}
  \setbeamerfont{subsubitem projected}{parent=subitem projected}

  \setbeamerfont{itemize item}{parent=item}
  \setbeamerfont{itemize subitem}{parent=subitem}
  \setbeamerfont{itemize subsubitem}{parent=subsubitem}

  \setbeamerfont{enumerate item}{parent=item}
  \setbeamerfont{enumerate subitem}{parent=subitem}
  \setbeamerfont{enumerate subsubitem}{parent=subsubitem}

  \setbeamerfont{itemize/enumerate body}{}
  \setbeamerfont{itemize/enumerate subbody}{size=\small}
  \setbeamerfont{itemize/enumerate subsubbody}{size=\footnotesize}

  \setbeamerfont{description item}{parent=item}

  \setbeamerfont{projected text}{parent={tiny structure}}

  \setbeamerfont{abstract}{size=\small}
  \setbeamerfont{abstract title}{parent={abstract,structure},size=\normalsize}

  \setbeamerfont{verse}{family=\rmfamily,shape=\itshape}

  \setbeamerfont{quotation}{shape=\itshape}
  \setbeamerfont{quote}{parent=quotation}

  \setbeamerfont{note page}{size=\small}

  % personnal additions
  \setbeamerfont{page number in head/foot}{size=\Tiny,shape=\scshape,series=\bfseries}%
}

%>>

\def\plaintheme{%
  %% —— fonts and colors —————————————————————————————— %%
  \plain@fonts
  \plain@colors
  %% —— title page ———————————————————————————————————— %%
  \defbeamertemplate*{title page}{acme}[1][]{%
    \setuptitlepage{##1}%
    \begin{tikzpicture}[remember picture, overlay]%
      %% thin line towards the bottom
      {\usebeamercolor{structure}
      \draw [color=fg, very thick]%
        ([xshift=\Gm@lmargin, yshift=200pt]current page.south west)%
        -- ++(\hsize,0);}%
      %% institute above that line
      \node [anchor=south west, inner sep=0pt]%
        at ([xshift=\Gm@lmargin, yshift=204pt]current page.south west)%
        {\usebeamer{institute}\insertshortinstitute};%
      %% title(/subtitle) below that line
      \node [anchor=north west, inner sep=0pt]%
        at ([xshift=\Gm@lmargin, yshift=196pt]current page.south west)%
        {\vbox\bgroup
          \hbox{\usebeamer{title}\strut\MakeLowercase\inserttitle}%
          \ifx\insertsubtitle\@empty\else%
            \hbox{\usebeamer{subtitle}\strut\insertsubtitle}\fi%
          \egroup};%
      %% date in the lower right corner
      \node [anchor=south east, inner sep=0pt]%
        at ([xshift=-\Gm@rmargin,yshift=10pt]current page.south east)%
        {\usebeamer{date}\insertshortdate};
    \end{tikzpicture}}%
  %%
  %% —— headline —————————————————————————————————————— %%
  \setuppagenumber{plain}
  \setbeamertemplate{headline}[acme]%
    [width=\hsize,lmargin=\Gm@lmargin+1pt, rmargin=\Gm@rmargin, tmargin=3pt, bmargin=0pt]%
    {left=title, right=page number}%
  %%
  %% —— footline —————————————————————————————————————— %%
  \setbeamertemplate{footline}[acme][width=\hsize]%
    {left=empty, center=empty, right=empty}%
  %%
  %% —— frametitle ———————————————————————————————————— %%
  \setbeamertemplate{frametitle}[acme]%
    [width=\hsize,frame=off, tframe=on, offset=0pt, toffset=1pt,
            options={draw=structure.fg, very thick}]%
    {\vbox\bgroup
      \hbox{\usebeamer{frametitle}\strut\insertframetitle}\vskip-6pt%
      \hbox{\usebeamer{framesubtitle}\insertframesubtitle}\egroup}
  %%
  %% —— blocks ———————————————————————————————————————— %%
  \setupblocks{plain}%
  \defineblocks%
  %%
  %% —— items ————————————————————————————————————————— %%
  \setitemizesstrutyes%
  \setbeamertemplate{itemize item}{%
    \acme@itemize@define\acmesquare{itemize item}%
    [yshift=1.6,color=fg,draw,fill,rounded corners=1,scale=4]}
  \let\enumerate\oldenumerate
}

%>>


%%% Local Variables:
%%% TeX-PDF-mode: t
%%% TeX-source-correlate-mode: nil
%%% TeX-master: "demo.tex"
%%% End:
